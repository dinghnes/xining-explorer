<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>西寧探險家：四界傳說</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            touch-action: manipulation;
            background-color: #0f172a;
            color: #f1f5f9;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes bounce-custom { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
        .animate-bounce-custom { animation: bounce-custom 1s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); } 50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); } }
        .node-pulse { animation: pulse-glow 2s infinite; }
        @keyframes boss-pulse { 0%, 100% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.6); transform: scale(1); } 50% { box-shadow: 0 0 30px rgba(220, 38, 38, 0.9); transform: scale(1.1); } }
        .node-boss { animation: boss-pulse 3s infinite; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .bg-grid-pattern { background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 30px 30px; }
        
        .guide-content h3 { color: #fbbf24; font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.25rem; }
        .guide-content h3:first-child { margin-top: 0; }
        .guide-content p { margin-bottom: 0.5rem; color: #cbd5e1; line-height: 1.6; font-size: 0.95rem; }
        .guide-content strong { color: #fff; font-weight: 900; }
        .guide-content .highlight { color: #f472b6; font-weight: bold; }
        .guide-content ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.9rem; }
        .guide-content li { margin-bottom: 0.25rem; }

        /* Leaderboard Table Alignment */
        .leaderboard-table { table-layout: fixed; }
        .leaderboard-table th { @apply text-left p-3 text-amber-500 border-b border-slate-600 font-bold bg-slate-800; }
        .leaderboard-table td { @apply p-3 border-b border-slate-700/50 truncate; }
        .leaderboard-table tr:hover { @apply bg-slate-800/50; }
        .col-rank { width: 15%; text-align: center; }
        .col-player { width: 30%; }
        .col-role { width: 30%; }
        .col-level { width: 15%; text-align: center; }
        .col-score { width: 10%; text-align: right; }
    </style>
</head>
<body class="overflow-hidden select-none h-screen flex flex-col">

    <div id="app" class="w-full h-full flex flex-col relative"></div>

    <!-- UI Components (Modal & Toast) -->
    <div id="custom-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border-2 border-amber-500 rounded-xl max-w-md w-full p-6 shadow-2xl transform scale-100 transition-transform animate-fade-in flex flex-col max-h-[80vh]">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4 flex-shrink-0">標題</h3>
            <div id="modal-content" class="mb-6 text-slate-300 overflow-y-auto flex-1 text-sm whitespace-pre-wrap">內容</div>
            <div id="modal-input-container" class="mb-4 hidden flex-shrink-0">
                <input type="text" id="modal-input" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white focus:border-amber-500 outline-none" placeholder="">
            </div>
            <div class="flex justify-end gap-3 flex-shrink-0">
                <button id="modal-cancel" class="px-4 py-2 text-slate-400 hover:text-white rounded">取消</button>
                <button id="modal-confirm" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold">確定</button>
            </div>
        </div>
    </div>

    <div id="custom-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-amber-500 text-white px-6 py-3 rounded-full shadow-2xl z-[110] hidden opacity-0 transition-opacity duration-300 flex items-center gap-2">
        <i data-lucide="info" class="w-5 h-5 text-amber-500"></i>
        <span id="toast-message" class="font-bold">訊息</span>
    </div>

    <script>
        // --- 設定 ---
        // 您的專屬 GAS 後端網址
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxUjnGfXcFhDSSfWCHUvRhSgoZ_lY_Bd2l-50O5i3KSKMq88Rjhpaq2Tc_jDQppe_tiUQ/exec";
        
        // --- UI UTILS ---
        function showModal({ title, message, inputPlaceholder, inputValue, showCancel = true, onConfirm }) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = message || '';
            
            const inputContainer = document.getElementById('modal-input-container');
            const input = document.getElementById('modal-input');
            
            if (inputPlaceholder !== undefined) {
                inputContainer.classList.remove('hidden');
                // 如果有提供預設值就填入，否則清空
                input.value = inputValue !== undefined ? inputValue : '';
                input.placeholder = inputPlaceholder;
                setTimeout(() => input.focus(), 100);
            } else {
                inputContainer.classList.add('hidden');
            }

            const cancelBtn = document.getElementById('modal-cancel');
            if (showCancel) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => { modal.classList.add('hidden'); };
            } else {
                cancelBtn.classList.add('hidden');
            }

            const confirmBtn = document.getElementById('modal-confirm');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                const val = input.value;
                if(inputPlaceholder !== undefined && !val) return;
                modal.classList.add('hidden');
                if (onConfirm) onConfirm(val);
            };

            modal.classList.remove('hidden');
        }

        function showToast(msg) {
            const toast = document.getElementById('custom-toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('hidden');
            void toast.offsetWidth; 
            toast.classList.remove('opacity-0');
            lucide.createIcons();
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- CHARACTERS ---
        const CHARACTERS = [
            { id: 'kegui', name: '魔法師科貴', gender: 'boy', role: 'Mage', desc: '西寧國小智力擔當，擅長快速吸收知識。', abilityName: '博學多聞', abilityDesc: '答對問題獲得的經驗值 +30%', stats: { hp: 100, xpBonus: 1.3, dmgReduction: 0, healOnHit: 0 }, avatar: '🧙‍♂️' },
            { id: 'chongyi', name: '野蠻人崇亦', gender: 'boy', role: 'Barbarian', desc: '體育課的王者，擁有驚人的體力。', abilityName: '蠻荒體魄', abilityDesc: '初始 HP 高達 130', stats: { hp: 130, xpBonus: 1.0, dmgReduction: 0, healOnHit: 0 }, avatar: '🏋️' },
            { id: 'peiyu', name: '麻法師姵妤', gender: 'girl', role: 'Mage', desc: '心思細膩，懂得如何在戰鬥中保護自己。', abilityName: '元素治癒', abilityDesc: '答對問題時回復 5 點 HP', stats: { hp: 100, xpBonus: 1.0, dmgReduction: 0, healOnHit: 5 }, avatar: '🧚‍♀️' },
            { id: 'yunqi', name: '女戰士妘萁', gender: 'girl', role: 'Warrior', desc: '亞馬遜的後裔，擅長防禦敵人的攻擊。', abilityName: '戰鬥格擋', abilityDesc: '答錯時受到的傷害減少 5 點', stats: { hp: 110, xpBonus: 1.0, dmgReduction: 5, healOnHit: 0 }, avatar: '🧝‍♀️' },
            { id: 'youchen', name: '死靈法師佑辰', gender: 'boy', role: 'Necromancer', desc: '來自幽冥的召喚師，能從答題中汲取生命能量。', abilityName: '靈魂汲取', abilityDesc: '答對問題回復 10 點 HP', stats: { hp: 90, xpBonus: 1.0, dmgReduction: 0, healOnHit: 10 }, avatar: '💀' },
            { id: 'bingjia', name: '一拳超人秉家', gender: 'boy', role: 'Hero', desc: '興趣是當英雄，每天都做100下伏地挺身。', abilityName: '認真答題', abilityDesc: '答對造成 25 點傷害 (一般為15)', stats: { hp: 100, xpBonus: 1.0, dmgReduction: 0, healOnHit: 0, dmgBonus: 10 }, avatar: '👊' },
            { id: 'book_immortal', name: '西寧書仙老頭', gender: 'elder', role: 'Guide', desc: '傳說中隱居在圖書館深處的老者，知曉所有奧祕。', abilityName: '萬卷天書', abilityDesc: '無法戰鬥與答題，但能查看所有關卡的重點攻略。', stats: { hp: 1, xpBonus: 0, dmgReduction: 0, healOnHit: 0 }, avatar: '👴' }
        ];

        // --- GUIDE DATA ---
        const GUIDE_DATA = {
            'river': `<div class="guide-content"><h3>1. 上游：陡峭與侵蝕</h3><p>河流上游就像溜滑梯的頂端，地勢很陡，水流<strong>非常急</strong>。</p><ul><li><strong>作用力</strong>：水流太快了，把石頭沖刷下來（<span class="highlight">侵蝕作用</span>）並搬運走（<span class="highlight">搬運作用</span>）。</li><li><strong>地形</strong>：V型谷、峽谷（太魯閣）、瀑布、壺穴。</li></ul><h3>2. 中游：變寬與搬運</h3><p>水流到了中間，速度稍微慢一點點，但還是能搬東西。</p><ul><li><strong>石頭</strong>：石頭在滾動過程中互相碰撞，尖角被磨掉了，變成圓圓胖胖的<span class="highlight">鵝卵石</span>。</li><li><strong>曲流</strong>：河道彎彎曲曲的。<ul><li><strong>凹岸</strong>：水流沖向這邊，水快、水深，發生<span class="highlight">侵蝕作用</span>（地基會被掏空，危險！）。</li><li><strong>凸岸</strong>：水流流過這邊變慢，發生<span class="highlight">堆積作用</span>（變成沙灘，適合玩水）。</li></ul></li></ul><h3>3. 下游：平坦與堆積</h3><p>快到大海了，地勢變平，水流<strong>變慢</strong>，搬不動東西了。</p><ul><li><strong>作用力</strong>：泥沙通通放下來，叫做<span class="highlight">堆積作用</span>。</li><li><strong>地形</strong>：形成寬廣的<strong>沖積平原</strong>（我們住的地方）。在出海口會堆成<span class="highlight">三角洲</span>。</li><li><strong>石頭</strong>：剩下細細的<strong>泥沙</strong>。</li></ul></div>`,
            'coast': `<div class="guide-content"><h3>1. 海浪的雕刻師：海蝕地形</h3><p>海浪不斷拍打岩石，把石頭「磨掉」或「打穿」，這就是<span class="highlight">侵蝕作用</span>。</p><ul><li><strong>豆腐岩</strong>：岩石有節理（裂縫），海水沿著裂縫切下去，切成一塊塊像豆腐（基隆和平島）。</li><li><strong>蕈狀岩</strong>：例如<span class="highlight">女王頭</span>。上面石頭硬，下面石頭軟，下面的脖子被風和海水磨細了（差異侵蝕）。</li><li><strong>演變過程</strong>：海蝕洞（挖一個洞）→ <span class="highlight">海蝕門/拱門</span>（打穿了）→ <span class="highlight">海蝕柱</span>（頂部塌了剩柱子）。</li><li><strong>老梅綠石槽</strong>：是<span class="highlight">海蝕溝</span>，上面長滿了綠藻。</li></ul><h3>2. 海浪的搬運工：海積地形</h3><p>海浪把沙子搬來搬去，堆在岸邊，這就是<span class="highlight">堆積作用</span>。</p><ul><li><strong>沙灘</strong>：福隆海水浴場金黃色的沙灘。</li><li><strong>沙洲</strong>：堆積在海中間長長的一條沙子（像鯤鯓）。</li><li><strong>潟湖</strong>：被沙洲擋住，在內側平靜的水域（像七股潟湖，適合養蚵）。</li><li><strong>陸連島</strong>：沙子堆積把小島和陸地連起來了（台東金樽）。</li></ul></div>`,
            'rocks': `<div class="guide-content"><h3>1. 岩石三大家族</h3><p>岩石依照「怎麼形成的」分成三大類：</p><ul><li><strong>火成岩</strong>（火氣很大）：岩漿冷卻變成的。<ul><li><span class="highlight">安山岩</span>：很硬，常拿來做廟宇的石獅、龍柱。</li><li><span class="highlight">玄武岩</span>：黑黑的，有氣孔（岩漿氣體跑掉），澎湖最多。</li><li><span class="highlight">花崗岩</span>：有黑、白、肉紅三種顏色顆粒（黑雲母、石英、長石），做地板常用。</li></ul></li><li><strong>沉積岩</strong>（層層堆疊）：泥沙一層層堆起來壓實的。<ul><li><span class="highlight">石灰岩</span>：以前是珊瑚礁，滴到<strong>稀鹽酸</strong>會冒泡泡（產生二氧化碳），是做水泥的原料。</li><li><strong>化石</strong>：最容易在沉積岩裡發現化石！</li></ul></li><li><strong>變質岩</strong>（壓力山大）：岩石被高溫高壓「烤」過變形了。<ul><li><span class="highlight">大理岩</span>：由石灰岩變來的，有美麗花紋。</li><li><span class="highlight">板岩</span>：由頁岩變來的，原住民拿來蓋石板屋。</li></ul></li></ul><h3>2. 礦物比一比</h3><ul><li><strong>硬度</strong>（誰最硬？）：<span class="highlight">滑石</span>（最軟） < 指甲 < <span class="highlight">方解石</span>（銅幣） < <span class="highlight">石英</span>（比玻璃硬） < <span class="highlight">金剛石</span>（鑽石，最硬）。</li><li><strong>特性</strong>：<ul><li><strong>硫磺</strong>：黃色，有臭雞蛋味，做火藥。</li><li><strong>石墨</strong>：黑色，會導電，做鉛筆芯。</li><li><strong>滑石</strong>：摸起來滑滑的，做爽身粉。</li></ul></li></ul></div>`,
            'disaster': `<div class="guide-content"><h3>1. 地震的大小怎麼看？</h3><p>地震報告會看到兩個重要的數字，千萬別搞混！</p><ul><li><span class="highlight">芮氏規模</span>：代表地震釋放的<strong>能量大小</strong>。<ul><li>全台灣<strong>只有一個數值</strong>。</li><li>有小數點，沒有單位。</li></ul></li><li><span class="highlight">震度</span>：代表你感覺到的<strong>搖晃程度</strong>。<ul><li><strong>各地不同</strong>。</li><li>分級：0級（無感）~ 7級（劇烈），共10個等級。</li></ul></li></ul><h3>2. 地震來了怎麼辦？</h3><ul><li><strong>保命三步驟</strong>：<span class="highlight">趴下、掩護、穩住</span>。</li><li><strong>不可以</strong>：搭電梯、慌張亂跑、點火。</li><li><strong>緊急避難包</strong>：要放乾糧、水、手電筒、電池、哨子、證件、保暖衣物。</li></ul></div>`,
            'magnet1': `<div class="guide-content"><h3>1. 磁鐵的個性</h3><ul><li><strong>磁極</strong>：磁力最強的地方在<strong>兩端</strong>（N極和S極）。</li><li><strong>相處之道</strong>：<span class="highlight">同極相斥</span>，<span class="highlight">異極相吸</span>。</li></ul><h3>2. 地球就是大磁鐵</h3><ul><li><strong>指北針原理</strong>：指北針的箭頭是N極。因為異極相吸，它會被地球的磁場吸引。</li><li><strong>重要觀念</strong>：地理的北極附近，其實是<span class="highlight">地磁的S極</span>；地理的南極附近，是<span class="highlight">地磁的N極</span>。</li></ul></div>`,
            'magnet2': `<div class="guide-content"><h3>1. 電也能生磁</h3><ul><li><strong>奧斯特的發現</strong>：通電的電線旁邊，指北針會偏轉！</li><li><strong>安培右手定則</strong>（簡單版）：<ul><li>電線放在指北針<strong>上方</strong> vs <strong>下方</strong>，指針偏轉方向會<span class="highlight">相反</span>。</li><li>電流方向改變，指針偏轉方向也會<span class="highlight">相反</span>。</li></ul></li></ul><h3>2. 超級電磁鐵</h3><p>怎麼讓電磁鐵變強？</p><ul><li><strong>加強法 1</strong>：<span class="highlight">串聯電池</span>。</li><li><strong>加強法 2</strong>：<span class="highlight">增加線圈圈數</span>。</li><li><strong>加強法 3</strong>：線圈裡面放入<span class="highlight">鐵棒</span>。</li></ul></div>`,
            'magnet3': `<div class="guide-content"><h3>1. 生活中的馬達</h3><ul><li><strong>原理</strong>：利用<span class="highlight">同極相斥、異極相吸</span>的原理，讓軸心轉動。</li><li><strong>應用</strong>：<span class="highlight">電風扇、洗衣機、吹風機</span>。</li></ul><h3>2. 磁浮列車</h3><ul><li><strong>原理</strong>：利用磁力讓車體<span class="highlight">懸浮</span>。</li><li><strong>優點</strong>：<span class="highlight">沒有摩擦力</span>，速度快、噪音小。</li></ul></div>`,
            'solution1': `<div class="guide-content"><h3>1. 溶解</h3><ul><li>物質在水中消失，看不見顆粒，這就是<span class="highlight">溶解</span>。</li><li><strong>重量守恆</strong>：溶解後，重量不會變輕！</li></ul><h3>2. 加速溶解</h3><ul><li><strong>攪拌、加熱、磨碎</strong>。</li></ul><h3>3. 飽和與分離</h3><ul><li><strong>飽和</strong>：吃不下了！水再也溶不進去鹽巴。</li><li><strong>分離</strong>：利用<strong>蒸發</strong>（晒太陽、加熱）把水趕走，留下鹽結晶。</li></ul></div>`,
            'solution2': `<div class="guide-content"><h3>1. 石蕊試紙</h3><p>口訣：<span class="highlight">酸紅鹼藍</span></p><ul><li><strong>酸性</strong>：變<span class="highlight">紅色</span>。</li><li><strong>鹼性</strong>：變<span class="highlight">藍色</span>。</li></ul><h3>2. 常見水溶液</h3><ul><li><strong>酸性</strong>：<span class="highlight">檸檬汁、白醋、汽水</span>。</li><li><strong>鹼性</strong>：<span class="highlight">小蘇打水、石灰水、氨水、肥皂水</span>。</li><li><strong>中性</strong>：<span class="highlight">食鹽水、糖水</span>。</li></ul></div>`,
            'solution3': `<div class="guide-content"><h3>1. 導電性</h3><p>能導電的水溶液稱為<span class="highlight">電解質</span>。</p><ul><li><strong>容易導電</strong>：酸、鹼、鹽類（檸檬汁、食鹽水）。</li><li><strong>不易導電</strong>：糖水、酒精、純水。</li></ul><h3>2. 安全</h3><p><span class="highlight">手溼溼的絕對不能碰電器開關</span>。</p></div>`,
            'force1': `<div class="guide-content"><h3>1. 力是什麼？</h3><p>力可以造成：移動、改變方向、變形、改變快慢。</p><h3>2. 接觸力 vs 超距力</h3><ul><li><strong>接觸力</strong>：推力、摩擦力、浮力、風力。</li><li><strong>超距力</strong>：<span class="highlight">地心引力、磁力、靜電力</span>。</li></ul></div>`,
            'force2': `<div class="guide-content"><h3>1. 彈簧秤</h3><ul><li><strong>虎克定律</strong>：<span class="highlight">掛越重，彈簧伸長越長</span>（成正比）。</li><li><strong>單位</strong>：<span class="highlight">公克重 (gw)</span>。</li></ul><h3>2. 測量</h3><ul><li>使用前要先<span class="highlight">歸零</span>。</li></ul></div>`,
            'force3': `<div class="guide-content"><h3>1. 摩擦力</h3><ul><li><strong>方向</strong>：跟物體運動方向<span class="highlight">相反</span>。</li></ul><h3>2. 影響因素</h3><ul><li><strong>接觸面</strong>：越<span class="highlight">粗糙</span>，摩擦力越大。</li><li><strong>重量</strong>：物體<span class="highlight">越重</span>，摩擦力越大。</li><li>跟接觸面積大小<strong>無關</strong>！</li></ul></div>`,
            'economy1': `<div class="guide-content"><h3>1. 土地改革</h3><p>三七五減租 → 公地放領 → 耕者有其田。</p><h3>2. 工業起飛</h3><ul><li><strong>輕工業</strong>：紡織、食品。</li><li><strong>加工出口區</strong>：<span class="highlight">高雄、楠梓、臺中</span>。吸引外資，增加就業。</li></ul></div>`,
            'economy2': `<div class="guide-content"><h3>1. 十大建設</h3><p>發展重工業（鋼鐵、造船）。交通建設：高速公路、鐵路電氣化。</p><h3>2. 科技島嶼</h3><ul><li><strong>科學園區</strong>：<span class="highlight">新竹</span>(竹科)。</li><li><strong>產業升級</strong>：從代工(OEM)轉向研發。</li></ul></div>`,
            'society1': `<div class="guide-content"><h3>1. 生活圈</h3><p>滿足就業、就學、購物需求的範圍。</p><h3>2. 一日生活圈</h3><p>因為<span class="highlight">高鐵、捷運</span>通車，交通變快了。</p></div>`,
            'society2': `<div class="guide-content"><h3>1. 都市化</h3><p>人口往都市集中。產生房價高、塞車、汙染等問題。</p><h3>2. 遷移原因</h3><ul><li><strong>拉力</strong>（都市好）：工作多、便利。</li><li><strong>推力</strong>（鄉村差）：工作少。</li></ul></div>`,
            'society3': `<div class="guide-content"><h3>1. 人口問題</h3><p>少子化、高齡化。</p><h3>2. 永續發展</h3><p><span class="highlight">地方創生</span>（救鄉村）、綠建築。</p></div>`,
            'history1': `<div class="guide-content"><h3>1. 舊石器 (長濱)</h3><p>打製石器、用火。</p><h3>2. 新石器 (大坌坑/卑南)</h3><p>磨製石器、陶器、定居農耕、石板棺。</p><h3>3. 金屬器 (十三行)</h3><p>煉鐵、交易(玻璃珠)。</p></div>`,
            'history2': `<div class="guide-content"><h3>1. 原住民族</h3><ul><li><strong>平埔</strong>：漢化較早。</li><li><strong>高山</strong>：16族。</li></ul><h3>2. 文化</h3><p>阿美豐年祭、賽夏矮靈祭、百步蛇傳說(排灣/魯凱)。</p></div>`,
            'history3': `<div class="guide-content"><h3>1. 荷蘭 (南台灣)</h3><p>熱蘭遮城(安平古堡)、貿易、新港文書(傳教)、黃牛。</p><h3>2. 西班牙 (北台灣)</h3><p>聖薩爾瓦多城(基隆)、紅毛城(淡水)。</p></div>`,
            'history4': `<div class="guide-content"><h3>1. 鄭成功</h3><p>反清復明、趕走荷蘭人。</p><h3>2. 建設</h3><p>陳永華建<strong>孔廟</strong>(全臺首學)。軍隊<strong>屯田</strong>(左營、新營)。</p></div>`,
            'history5': `<div class="guide-content"><h3>1. 清領初期</h3><p>施琅攻台。<strong>渡台禁令</strong>(禁攜眷)導致<strong>羅漢腳</strong>(單身男)多。</p><h3>2. 水利</h3><p>瑠公圳(台北)、八堡圳(彰化)、曹公圳(高雄)。</p></div>`
        };

        // --- GAME DATA (擴充題庫架構) ---
        // 本地題目已清空，將由 fetchExtendedQuestions 從雲端讀取
        const GAME_DATA = {
            worlds: [
                {
                    id: 'world1',
                    title: '第一世界：地質與磁場 (6上自然)',
                    bg: 'from-slate-900 via-slate-800 to-black',
                    zones: [
                        { id: 'river', name: '蜿蜒溪流', icon: 'droplet', color: 'text-blue-500', mapPos: { top: '80%', left: '10%' }, enemies: [{ name: '上游巨石怪', hp: 225, dialogue: '我的題庫深不見底！', questions: [] }] },
                        { id: 'coast', name: '狂風海岸', icon: 'map', color: 'text-cyan-500', mapPos: { top: '65%', left: '20%' }, enemies: [{ name: '海蝕幽靈', hp: 225, dialogue: '你能抵擋海浪的攻勢嗎？', questions: [] }] },
                        { id: 'rocks', name: '礦物王國', icon: 'hammer', color: 'text-gray-400', mapPos: { top: '50%', left: '30%' }, enemies: [{ name: '岩石巨人', hp: 225, dialogue: '硬碰硬，你贏不了！', questions: [] }] },
                        { id: 'disaster', name: '震動山脈', icon: 'alert-triangle', color: 'text-red-500', mapPos: { top: '35%', left: '40%' }, enemies: [{ name: '震波龍', hp: 225, dialogue: '震度7級的衝擊！', questions: [] }] },
                        { id: 'magnet1', name: '迷霧磁林', icon: 'compass', color: 'text-purple-400', mapPos: { top: '35%', left: '60%' }, enemies: [{ name: '地磁守護者', hp: 225, dialogue: '指南針會告訴你真相！', questions: [] }] },
                        { id: 'magnet2', name: '雷電遺跡', icon: 'zap', color: 'text-yellow-400', mapPos: { top: '55%', left: '70%' }, enemies: [{ name: '線圈魔像', hp: 225, dialogue: '電流增強，磁力增強！', questions: [] }] },
                        { id: 'magnet3', name: '磁浮未來城', icon: 'cpu', color: 'text-pink-400', mapPos: { top: '80%', left: '80%' }, enemies: [{ name: '機甲博士', hp: 225, dialogue: '馬達全速運轉！', questions: [] }] },
                        { id: 'boss1', name: '魔王關：地心試煉', icon: 'skull', color: 'text-purple-600', mapPos: { top: '55%', left: '50%' }, enemies: [{ name: '磁力龍王', hp: 500, dialogue: '吾乃地心之主，接受最終試煉吧！', questions: [] }] }
                    ]
                },
                // --- 第二世界 (5上自然) ---
                {
                    id: 'world2',
                    title: '第二世界：水鍊金與力場 (5上自然)',
                    bg: 'from-indigo-900 via-purple-900 to-black',
                    zones: [
                        { id: 'solution1', name: '神秘溶洞', icon: 'flask-conical', color: 'text-blue-300', mapPos: { top: '80%', left: '20%' }, enemies: [{ name: '結晶史萊姆', hp: 225, dialogue: '飽和...析出...', questions: [] }] },
                        { id: 'solution2', name: '酸鹼實驗室', icon: 'test-tube', color: 'text-green-400', mapPos: { top: '60%', left: '30%' }, enemies: [{ name: '石蕊試劑怪', hp: 225, dialogue: '變紅還是變藍？', questions: [] }] },
                        { id: 'solution3', name: '導電光廊', icon: 'lightbulb', color: 'text-yellow-300', mapPos: { top: '40%', left: '40%' }, enemies: [{ name: '電解質幽靈', hp: 225, dialogue: '電流通過中！', questions: [] }] },
                        { id: 'force1', name: '重力荒野', icon: 'arrow-down', color: 'text-orange-500', mapPos: { top: '30%', left: '60%' }, enemies: [{ name: '引力巨獸', hp: 225, dialogue: '萬有引力！', questions: [] }] },
                        { id: 'force2', name: '測量高塔', icon: 'scale', color: 'text-teal-400', mapPos: { top: '50%', left: '75%' }, enemies: [{ name: '精準機關人', hp: 225, dialogue: '1克都不能差！', questions: [] }] },
                        { id: 'force3', name: '摩擦峽谷', icon: 'move', color: 'text-rose-500', mapPos: { top: '80%', left: '85%' }, enemies: [{ name: '阻力岩怪', hp: 225, dialogue: '寸步難行！', questions: [] }] },
                        { id: 'boss2', name: '魔王關：真理聖殿', icon: 'skull', color: 'text-purple-600', mapPos: { top: '50%', left: '50%' }, enemies: [{ name: '真理賢者', hp: 500, dialogue: '水與力的奧義，你真的參透了嗎？', questions: [] }] }
                    ]
                },
                // --- 第三世界 (6上社會) ---
                {
                    id: 'world3',
                    title: '第三世界：社會與變遷 (6上社會)',
                    bg: 'from-amber-900 via-stone-800 to-black',
                    zones: [
                        { id: 'economy1', name: '起飛平原', icon: 'wheat', color: 'text-amber-500', mapPos: { top: '80%', left: '15%' }, enemies: [{ name: '土地改革者', hp: 225, dialogue: '耕者有其田！', questions: [] }] },
                        { id: 'economy2', name: '矽晶山谷', icon: 'microchip', color: 'text-teal-500', mapPos: { top: '55%', left: '30%' }, enemies: [{ name: '晶圓機器人', hp: 225, dialogue: '產業正在升級中...', questions: [] }] },
                        { id: 'society1', name: '生活圈迷宮', icon: 'train-front', color: 'text-blue-500', mapPos: { top: '30%', left: '50%' }, enemies: [{ name: '捷運速龍', hp: 225, dialogue: '一日生活圈！', questions: [] }] },
                        { id: 'society2', name: '擁擠都會', icon: 'building-2', color: 'text-gray-400', mapPos: { top: '45%', left: '75%' }, enemies: [{ name: '塞車怪獸', hp: 225, dialogue: '叭叭叭！', questions: [] }] },
                        { id: 'society3', name: '永續方舟', icon: 'leaf', color: 'text-green-500', mapPos: { top: '80%', left: '85%' }, enemies: [{ name: '時光守護者', hp: 225, dialogue: '為了下一代！', questions: [] }] },
                        { id: 'boss3', name: '魔王關：經建總署', icon: 'skull', color: 'text-purple-600', mapPos: { top: '50%', left: '50%' }, enemies: [{ name: '發展部長', hp: 500, dialogue: '社會的變遷，你跟上了嗎？', questions: [] }] }
                    ]
                },
                // --- 第四世界 (5上社會) ---
                {
                    id: 'world4',
                    title: '第四世界：歷史與文化 (5上社會)',
                    bg: 'from-amber-900 via-blue-900 to-black',
                    zones: [
                        { id: 'history1', name: '史前遺跡', icon: 'fossil', color: 'text-amber-600', mapPos: { top: '80%', left: '15%' }, enemies: [{ name: '石器先祖', hp: 225, dialogue: '嗚嘎嘎！(原始人語)', questions: [] }] },
                        { id: 'history2', name: '部落傳說', icon: 'feather', color: 'text-emerald-500', mapPos: { top: '55%', left: '25%' }, enemies: [{ name: '百步蛇神', hp: 225, dialogue: '祖靈在看著你。', questions: [] }] },
                        { id: 'history3', name: '航海時代', icon: 'ship', color: 'text-sky-500', mapPos: { top: '30%', left: '50%' }, enemies: [{ name: '荷蘭船長', hp: 225, dialogue: '要買鹿皮嗎？', questions: [] }] },
                        { id: 'history4', name: '明鄭王朝', icon: 'crown', color: 'text-red-600', mapPos: { top: '45%', left: '75%' }, enemies: [{ name: '延平郡王', hp: 225, dialogue: '驅逐紅毛番！', questions: [] }] },
                        { id: 'history5', name: '文化交融', icon: 'scroll', color: 'text-indigo-500', mapPos: { top: '80%', left: '85%' }, enemies: [{ name: '渡台移民', hp: 225, dialogue: '唐山過台灣，心肝結歸丸...', questions: [] }] },
                        { id: 'boss4', name: '魔王關：歷史迴廊', icon: 'skull', color: 'text-purple-600', mapPos: { top: '50%', left: '50%' }, enemies: [{ name: '時光守護神', hp: 500, dialogue: '歷史的洪流，你能記住多少？', questions: [] }] }
                    ]
                }
            ]
        };

        // --- STATE ---
        let gameState = 'START'; 
        let currentWorldIndex = 0;
        let player = { name: '', role: '', hp: 100, maxHp: 100, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: null, stats: {}, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
        let currentZone = null, currentEnemy = null, currentQuestion = null;
        let battleLog = [], enemyIndex = 0, showZoneInfo = null, questionCountInBattle = 0;
        let showCheerMessage = false;
        let leaderboardData = [];
        let showLeaderboard = false;
        let activeLeaderboardTab = 0;
        let showGameIntro = false;
        let cheatCodeBuffer = "";
        let isQuestionsLoaded = false; 
        let showDebugButton = false; 
        
        // 新增：戰鬥統計
        let battleStats = { startTime: 0, correct: 0, attempts: 0, score: 0 };

        // --- HELPERS ---
        function addLog(text) { battleLog.push(text); if (battleLog.length > 4) battleLog.shift(); renderApp(); }
        
        function unlockZone(zoneId) {
            if (player.characterId === 'book_immortal') return true;
            const world = GAME_DATA.worlds[currentWorldIndex];
            
            // Check if it is a boss zone
            if (zoneId.startsWith('boss')) {
                const normalZones = world.zones.filter(z => !z.id.startsWith('boss'));
                // Check if all normal zones are completed
                return normalZones.every(z => player.completedZones.includes(z.id));
            }
            
            // Normal zones are always unlocked
            return true;
        }

        function getUnsolvedQuestion(enemy) {
            const available = enemy.questions.filter(q => !player.solvedQuestionIds.includes(q.id));
            if (available.length === 0) return null;
            return available[Math.floor(Math.random() * available.length)];
        }

        function prepareQuestion(q) {
            let indices = q.options.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            return { ...q, shuffledOptions: indices.map(i => q.options[i]), correctIndex: indices.indexOf(q.a) };
        }
        
        // --- FETCH EXTENDED QUESTIONS ---
        async function diagnoseConnection() {
            if (!GAS_API_URL) {
                showModal({title: "設定錯誤", message: "請先在程式碼中設定 GAS_API_URL！", showCancel: false});
                return;
            }
            
            showToast("正在診斷連線...");
            try {
                const start = Date.now();
                const res = await fetch(GAS_API_URL + "?op=questions&t=" + start);
                const text = await res.text(); 
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error("API 回傳的不是 JSON。可能是權限不足 (需要設為所有人)，或 Apps Script 發生錯誤。\n回傳內容前 100 字:\n" + text.substring(0, 100));
                }

                if (data.error) {
                    throw new Error("GAS 內部錯誤: " + data.message);
                }

                let stats = "";
                let total = 0;
                Object.keys(data).forEach(zoneId => {
                    stats += `${zoneId}: ${data[zoneId].length} 題\n`;
                    total += data[zoneId].length;
                });

                if (total === 0) {
                    showModal({
                        title: "連線成功但無題目", 
                        message: "成功連線到 GAS，但沒有讀取到任何題目。\n請檢查：\n1. Google 試算表是否有 'world1' 等工作表？\n2. 工作表名稱是否包含 'world' (不分大小寫)？\n3. 內容是否有從 A2 開始填寫？",
                        showCancel: false
                    });
                } else {
                    showModal({
                        title: "連線診斷成功", 
                        message: `成功讀取到 ${total} 題！\n\n詳細分佈：\n${stats}\n\n如果不見題目，請重新整理網頁。`,
                        showCancel: false
                    });
                    processQuestionData(data);
                }

            } catch (e) {
                showModal({
                    title: "連線失敗", 
                    message: "無法連線到後端。\n錯誤訊息: " + e.message + "\n\n常見原因：\n1. GAS 部署時「誰可以存取」未設為「所有人」。\n2. GAS 程式碼未更新 (請建立新版部署)。",
                    showCancel: false
                });
            }
        }

        function processQuestionData(data) {
            let count = 0;
            GAME_DATA.worlds.forEach(w => {
                w.zones.forEach(z => {
                    if (data[z.id] && Array.isArray(data[z.id])) {
                        const enemy = z.enemies[0];
                        enemy.questions = [];
                        enemy.questions.push(...data[z.id]);
                        count += data[z.id].length;
                    }
                });
            });
            
            GAME_DATA.worlds.forEach(world => {
                const bossZone = world.zones.find(z => z.id.startsWith('boss'));
                if (bossZone) {
                    const bossEnemy = bossZone.enemies[0];
                    bossEnemy.questions = []; 
                    world.zones.forEach(z => {
                        if (z !== bossZone) {
                            z.enemies.forEach(e => {
                                bossEnemy.questions.push(...e.questions);
                            });
                        }
                    });
                }
            });
            
            if (count > 0) {
                isQuestionsLoaded = true;
                showToast(`已載入 ${count} 題！`);
            }
        }

        async function fetchExtendedQuestions() {
            if (!GAS_API_URL) return;
            try {
                const res = await fetch(GAS_API_URL + "?op=questions&t=" + new Date().getTime());
                const data = await res.json();
                processQuestionData(data);
            } catch (e) {
                console.warn("Auto-fetch failed, use debug button.", e);
            }
        }
        
        fetchExtendedQuestions();

        // --- CHEAT CODE LOGIC ---
        document.addEventListener('keydown', (e) => {
            if (e.key.length === 1) {
                cheatCodeBuffer += e.key;
                if (cheatCodeBuffer.length > 30) {
                    cheatCodeBuffer = cheatCodeBuffer.slice(-30);
                }
            }

            const targetMap = "2u/2u/xl3gw94gj94xk7";
            const targetDebug = "hk4g4xu06vu04";
            const bufferNormalized = cheatCodeBuffer.replace(/\s/g, '');
            
            if (gameState === 'MAP' && bufferNormalized.includes(targetMap)) {
                activateCheat();
                cheatCodeBuffer = ""; 
            }

            if (gameState === 'START' && bufferNormalized.includes(targetDebug)) {
                showDebugButton = true;
                showToast("除錯模式已啟用");
                renderApp();
                cheatCodeBuffer = "";
            }
        });

        function handleTitleClick() {
             if (gameState !== 'MAP') return;
             if (!window.titleClickCount) window.titleClickCount = 0;
             window.titleClickCount++;
             
             if (window.titleClickCount >= 5) {
                 window.titleClickCount = 0;
                 showModal({
                    title: '密技',
                    inputPlaceholder: '請輸入密技指令',
                    onConfirm: (code) => {
                        if (code && code.replace(/\s/g, '') === "2u/2u/xl3gw94gj94xk7") {
                            activateCheat();
                        }
                    }
                 });
             }
             
             if (window.titleClickTimer) clearTimeout(window.titleClickTimer);
             window.titleClickTimer = setTimeout(() => { window.titleClickCount = 0; }, 2000);
        }

        function activateCheat() {
            showToast("密技啟動：老師太帥了！得分 9999！");
            
            const currentWorld = GAME_DATA.worlds[currentWorldIndex];
            currentWorld.zones.forEach(z => {
                if (!player.completedZones.includes(z.id)) {
                    player.completedZones.push(z.id);
                }
            });
            
            player.level = 99;
            player.hp = 9999;
            player.maxHp = 9999;
            
            uploadCheatScore();
            
            renderApp();
        }

        function uploadCheatScore() {
            if (!GAS_API_URL) return;
            let defaultName = player.name;
            if (!defaultName || defaultName === CHARACTERS.find(c => c.id === player.characterId).name) {
                 defaultName = "神祕高手";
            }

            showModal({
                title: '登錄英雄榜 (密技版)',
                message: '請輸入您的名字：',
                inputPlaceholder: defaultName,
                onConfirm: (userName) => {
                    if (!userName) userName = "神祕高手";
                    player.name = userName;

                    const payload = {
                        name: userName,
                        role: CHARACTERS.find(c => c.id === player.characterId).name,
                        world: GAME_DATA.worlds[currentWorldIndex].title,
                        level: 99,
                        score: 9999
                    };
                    
                    fetch(GAS_API_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    }).then(() => {
                        console.log("Cheat score uploaded.");
                        showToast("密技成績已登錄！");
                    });
                }
            });
        }

        // --- API ACTIONS ---
        function uploadScore() {
            if (!GAS_API_URL) {
                showToast("請先設定 GAS_API_URL！");
                return;
            }
            
            const currentPlayerName = player.name;
            const defaultCharName = CHARACTERS.find(c => c.id === player.characterId).name;
            const inputValue = (currentPlayerName && currentPlayerName !== defaultCharName) ? currentPlayerName : '';
            const currentWorldScore = player.worldScores[currentWorldIndex] || 0;

            showModal({
                title: '上傳戰績',
                message: `上傳目前世界總積分: ${currentWorldScore}\n請輸入您的名字以便登錄英雄榜：`,
                inputPlaceholder: '請輸入名字 (如: 601 王小明)',
                inputValue: inputValue,
                onConfirm: (userName) => {
                    if (!userName) return;
                    player.name = userName;

                    const payload = {
                        name: userName,
                        role: CHARACTERS.find(c => c.id === player.characterId).name,
                        world: GAME_DATA.worlds[currentWorldIndex].title,
                        level: player.level,
                        score: currentWorldScore // 上傳當前世界的累積總分
                    };

                    addLog("正在上傳戰績...");
                    
                    fetch(GAS_API_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(() => {
                        addLog("戰績上傳成功！");
                        showToast("戰績上傳成功！");
                        if (!player.uploadedZones.includes(currentZone.id)) {
                            player.uploadedZones.push(currentZone.id);
                        }
                        renderApp();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        addLog("上傳失敗，請檢查網路。");
                        showToast("上傳失敗！");
                    });
                }
            });
        }

        function fetchLeaderboard() {
            if (!GAS_API_URL) {
                leaderboardData = [
                    { name: "測試玩家1", role: "魔法師科貴", world: "第一世界", level: 5, score: 20 },
                    { name: "測試玩家2", role: "女戰士妘萁", world: "第一世界", level: 3, score: 15 }
                ];
                renderApp();
                return;
            }

            fetch(GAS_API_URL)
            .then(response => response.json())
            .then(data => {
                leaderboardData = data;
                renderApp();
            })
            .catch(error => {
                console.error("Error fetching leaderboard:", error);
                leaderboardData = []; 
                renderApp();
            });
        }

        function toggleLeaderboard() {
            showLeaderboard = !showLeaderboard;
            if (showLeaderboard) {
                fetchLeaderboard();
            }
            renderApp();
        }

        function switchLeaderboardTab(index) {
            activeLeaderboardTab = index;
            renderApp();
        }
        
        function toggleGameIntro() {
            showGameIntro = !showGameIntro;
            renderApp();
        }

        // --- ACTIONS ---
        function switchWorld(index) {
            currentWorldIndex = index;
            showZoneInfo = null;
            renderApp();
        }

        function toCharSelect() { gameState = 'CHAR_SELECT'; renderApp(); }
        
        function returnToMainMenu() { 
            gameState = 'START';
            player = { name: '', role: '', hp: 100, maxHp: 100, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: null, stats: {}, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
            battleLog = [];
            currentWorldIndex = 0;
            renderApp();
        }

        function forgetClothes() {
            gameState = 'START';
            player = { name: '', role: '', hp: 100, maxHp: 100, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: null, stats: {}, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
            battleLog = [];
            currentWorldIndex = 0;
            showCheerMessage = true;
            renderApp();
            setTimeout(() => {
                showCheerMessage = false;
                renderApp();
            }, 3000);
        }

        function selectCharacter(charId) {
            const char = CHARACTERS.find(c => c.id === charId);
            player = { name: char.name, role: char.role, hp: char.stats.hp, maxHp: char.stats.hp, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: char.id, stats: char.stats, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
            gameState = 'MAP';
            battleLog = char.id === 'book_immortal' ? ['歡迎書仙！', '攻略模式開啟。'] : [`歡迎 ${char.name}！`, `能力：${char.abilityName}`];
            if(char.id === 'book_immortal') {
                GAME_DATA.worlds.forEach(w => w.zones.forEach(z => player.completedZones.push(z.id)));
            }
            renderApp();
        }

        function enterZone(zoneId) {
            const world = GAME_DATA.worlds[currentWorldIndex];
            const zone = world.zones.find(z => z.id === zoneId);
            
            if (player.characterId !== 'book_immortal' && !zone.id.startsWith('boss')) {
                if (zone.enemies[0].questions.length === 0) {
                    showModal({
                        title: "題庫未就緒", 
                        message: "尚未從雲端讀取到題目，請先按右下角的「測試連線」檢查。", 
                        showCancel: false
                    });
                    return;
                }
            }

            if (!unlockZone(zone.id)) return;
            currentZone = zone;
            showZoneInfo = null;
            if (player.characterId === 'book_immortal') { gameState = 'GUIDE'; renderApp(); } 
            else { enemyIndex = 0; startBattle(zone.enemies[0]); }
        }

        function startBattle(enemy) {
            // 初始化戰鬥統計
            battleStats = { startTime: Date.now(), correct: 0, attempts: 0, score: 0 };

            const allQuestions = enemy.questions;
            
            let pool = [];
            if (currentZone.id.startsWith('boss')) {
                 pool = allQuestions.filter(q => !player.solvedQuestionIds.includes(q.id));
                 if (pool.length === 0) {
                     battleLog.push(`🎉 ${enemy.name} 試煉完成！`); 
                     handleEnemyDefeat(enemy); 
                     return; 
                 }
            } else {
                 pool = [...allQuestions];
            }

            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }

            const battleQuestions = pool.slice(0, 15);
            
            enemy.battleQuestions = battleQuestions;
            enemy.battleIndex = 0;

            currentEnemy = { ...enemy, currentHp: 225 }; 
            
            if (battleQuestions.length > 0) {
                currentQuestion = prepareQuestion(battleQuestions[0]);
                gameState = 'BATTLE';
                battleLog.push(`遭遇：${enemy.name}！`);
            } else {
                handleEnemyDefeat(enemy);
            }
            renderApp();
        }

        function handleAnswer(idx) {
            if (!currentQuestion) return;
            const isCorrect = idx === currentQuestion.correctIndex;
            
            // 更新戰鬥統計
            battleStats.attempts++;

            if (isCorrect) {
                battleStats.correct++;
                
                const baseDmg = 15 + (player.stats.dmgBonus || 0);
                currentEnemy.currentHp -= baseDmg;
                addLog(`✅ 正確！傷害 ${baseDmg}！`);
                if(!player.solvedQuestionIds.includes(currentQuestion.id)) player.solvedQuestionIds.push(currentQuestion.id);
                if (player.stats.healOnHit > 0) player.hp = Math.min(player.maxHp, player.hp + player.stats.healOnHit);
                const xpGain = Math.floor(15 * player.stats.xpBonus);
                player.xp += xpGain;
                if (player.xp >= player.maxXp) { player.xp -= player.maxXp; player.level++; player.maxXp = Math.floor(player.maxXp*1.5); player.hp = player.maxHp; addLog('🎉 升級！'); }
                
                currentEnemy.battleIndex++;
                if (currentEnemy.currentHp <= 0 || currentEnemy.battleIndex >= currentEnemy.battleQuestions.length) {
                    handleEnemyDefeat(currentEnemy);
                } else {
                    const nextQ = currentEnemy.battleQuestions[currentEnemy.battleIndex];
                    setTimeout(() => { currentQuestion = prepareQuestion(nextQ); renderApp(); }, 1000);
                }
            } else {
                const dmg = Math.max(1, 15 - player.stats.dmgReduction);
                player.hp -= dmg;
                addLog(`❌ 錯誤！受傷 ${dmg}`);
                addLog(`正解：${currentQuestion.options[currentQuestion.a]}`);
                if (player.hp <= 0) setTimeout(() => { gameState = 'GAMEOVER'; renderApp(); }, 1000);
                else renderApp();
            }
        }

        function handleEnemyDefeat(enemy) {
            // 計算本關積分
            const endTime = Date.now();
            const durationSec = Math.floor((endTime - battleStats.startTime) / 1000);
            const accuracy = battleStats.attempts > 0 ? (battleStats.correct / battleStats.attempts) : 0;
            const timeBonus = Math.max(0, (300 - durationSec) * 10); // 300秒內，每快1秒+10分
            const baseScore = battleStats.correct * 1000;
            
            const levelScore = Math.floor(baseScore * Math.pow(accuracy, 2) + timeBonus);
            
            // 累積當前世界的總分
            if (!player.worldScores[currentWorldIndex]) {
                 player.worldScores[currentWorldIndex] = 0;
            }
            player.worldScores[currentWorldIndex] += levelScore;

            battleStats.score = levelScore;
            battleStats.duration = durationSec;
            battleStats.accuracy = (accuracy * 100).toFixed(1);

            addLog(`🏆 擊敗 ${enemy.name}！`);
            if (!player.completedZones.includes(currentZone.id)) player.completedZones.push(currentZone.id);
            gameState = 'VICTORY';
            renderApp();
        }

        function showZonePopup(zoneId) { if(unlockZone(zoneId)) { showZoneInfo = GAME_DATA.worlds[currentWorldIndex].zones.find(z => z.id === zoneId); renderApp(); } }
        function closeZonePopup() { showZoneInfo = null; renderApp(); }
        function returnToMap() { gameState = 'MAP'; showZoneInfo = null; renderApp(); }
        function restartGame() { gameState = 'START'; renderApp(); }

        // --- RENDER ---
        function renderApp() {
            const app = document.getElementById('app');
            let content = '';
            
            if (showCheerMessage) {
                content += `
                <div class="fixed top-0 left-0 w-full h-full flex items-center justify-center z-50 bg-black/80 pointer-events-none animate-fade-in">
                    <div class="bg-amber-600 text-white px-8 py-4 rounded-xl text-2xl font-bold shadow-2xl transform scale-110">
                        加油好嗎?
                    </div>
                </div>`;
            }

            if (gameState !== 'START' && gameState !== 'CHAR_SELECT') {
                content += `
                <header class="bg-slate-900 border-b border-slate-800 p-2 flex justify-between items-center z-20 shadow-lg">
                    <div class="flex gap-2 items-center">
                        <span class="font-bold text-amber-100 cursor-pointer select-none active:scale-95 transition-transform" onclick="handleTitleClick()">西寧探險家</span>
                        ${gameState === 'MAP' ? `
                        <div class="flex bg-slate-800 rounded p-1">
                            <button onclick="switchWorld(0)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===0 ? 'bg-amber-600 text-white' : 'text-slate-400'}">W1</button>
                            <button onclick="switchWorld(1)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===1 ? 'bg-indigo-600 text-white' : 'text-slate-400'}">W2</button>
                            <button onclick="switchWorld(2)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===2 ? 'bg-teal-600 text-white' : 'text-slate-400'}">W3</button>
                            <button onclick="switchWorld(3)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===3 ? 'bg-emerald-600 text-white' : 'text-slate-400'}">W4</button>
                        </div>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${player.role !== 'Guide' ? `<button onclick="toggleLeaderboard()" class="p-1.5 bg-yellow-600 hover:bg-yellow-500 rounded text-white shadow"><i data-lucide="trophy" class="w-4 h-4"></i></button>` : ''}
                        <div class="text-xs text-slate-300">Lv.${player.level}</div>
                        <button onclick="returnToMap()" class="px-2 py-1 bg-slate-700 text-xs rounded">地圖</button>
                    </div>
                </header>`;
            }

            content += `<main class="flex-1 overflow-auto bg-gradient-to-b ${GAME_DATA.worlds[currentWorldIndex].bg} relative w-full h-full">`;
            
            if (gameState === 'START') content += renderStart();
            else if (gameState === 'CHAR_SELECT') content += renderCharSelect();
            else if (gameState === 'MAP') content += renderMap();
            else if (gameState === 'BATTLE') content += renderBattle();
            else if (gameState === 'VICTORY') content += renderVictory();
            else if (gameState === 'GAMEOVER') content += renderGameOver();
            else if (gameState === 'GUIDE') content += renderGuide();

            if (showGameIntro) {
                content += `
                <div class="absolute inset-0 z-50 bg-black/90 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-slate-900 border border-blue-500/50 w-full max-w-2xl h-3/4 rounded-xl flex flex-col shadow-2xl">
                        <div class="flex justify-between items-center p-4 border-b border-slate-700">
                            <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2"><i data-lucide="book-open"></i> 遊戲介紹</h2>
                            <button onclick="toggleGameIntro()" class="text-slate-400 hover:text-white">✕</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 text-slate-300 space-y-4">
                            <h3 class="text-lg font-bold text-white">故事背景</h3>
                            <p>西寧國小正面臨一場跨越時空的危機！你需要運用自然與社會科的知識，通過四大世界的試煉，解開地質、磁場、水力與歷史的謎團。</p>
                            <h3 class="text-lg font-bold text-white">四大世界</h3>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><span class="text-amber-400">第一世界</span>：探索河流地形與磁鐵奧祕 (6上自然)。</li>
                                <li><span class="text-indigo-400">第二世界</span>：掌握水溶液性質與力的作用 (5上自然)。</li>
                                <li><span class="text-teal-400">第三世界</span>：見證台灣經濟起飛與社會變遷 (6上社會)。</li>
                                <li><span class="text-emerald-400">第四世界</span>：穿越史前與大航海時代的歷史 (5上社會)。</li>
                            </ul>
                            <h3 class="text-lg font-bold text-white">角色介紹</h3>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>科貴</strong>：經驗值加成，升級快。</li>
                                <li><strong>崇亦</strong>：血量高，耐打。</li>
                                <li><strong>姵妤</strong>：答對回血，續航力強。</li>
                                <li><strong>妘萁</strong>：答錯減傷，容錯率高。</li>
                                <li><strong>佑辰</strong>：答對大幅回血，生存專家。</li>
                                <li><strong>秉家</strong>：攻擊力超高，一擊必殺。</li>
                                <li><strong>書仙老頭</strong>：無法戰鬥，專門用來查看「攻略筆記」。</li>
                            </ul>
                            <h3 class="text-lg font-bold text-white">玩法說明</h3>
                            <p>選擇關卡進行答題戰鬥，答對扣敵血，答錯扣己血。每個世界最後都有一個擁有 500 血量的「魔王關」，考驗你的綜合實力！</p>
                            
                            <!-- 新增部分 -->
                            <h3 class="text-lg font-bold text-white">🏆 戰績積分規則</h3>
                            <div class="bg-slate-800 p-3 rounded-lg border border-slate-600 text-sm">
                                <p class="mb-2 text-amber-300 font-bold">總分 = (答對題數 × 1000) × (答對率)² + 時間加成</p>
                                <ul class="list-disc pl-4 space-y-1 text-slate-400">
                                    <li><strong>極度重視答對率</strong>：因為是平方計算，錯一題分數會扣非常多！(例：答對率 80%，分數只剩 64%)</li>
                                    <li><strong>時間加成</strong>：基準 300 秒，每提早 1 秒 + 10 分。</li>
                                    <li><strong>分世界計算</strong>：每個世界的積分是分開累積的，無法帶到下一個世界。</li>
                                    <li><strong>策略建議</strong>：寧可慢一點想清楚，也不要亂猜喔！</li>
                                </ul>
                            </div>
                        </div>
                        <div class="p-4 border-t border-slate-700">
                            <button onclick="toggleGameIntro()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">我準備好了！</button>
                        </div>
                    </div>
                </div>`;
            }

            if (showLeaderboard) {
                const currentWorldTitle = GAME_DATA.worlds[activeLeaderboardTab].title;
                const filteredData = leaderboardData.filter(d => d.world && d.world.includes(GAME_DATA.worlds[activeLeaderboardTab].title.split('：')[1].split(' (')[0])); 

                content += `
                <div class="absolute inset-0 z-50 bg-black/90 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-slate-900 border border-amber-500/50 w-full max-w-2xl h-3/4 rounded-xl flex flex-col shadow-2xl">
                        <div class="flex justify-between items-center p-4 border-b border-slate-700">
                            <h2 class="text-xl font-bold text-amber-400 flex items-center gap-2"><i data-lucide="trophy"></i> 英雄榜</h2>
                            <button onclick="toggleLeaderboard()" class="text-slate-400 hover:text-white">✕</button>
                        </div>
                        <div class="flex bg-slate-800 p-2 gap-2 overflow-x-auto">
                            ${GAME_DATA.worlds.map((w, i) => `
                                <button onclick="switchLeaderboardTab(${i})" class="px-3 py-1 rounded text-sm whitespace-nowrap ${activeLeaderboardTab === i ? 'bg-amber-600 text-white' : 'bg-slate-700 text-slate-400'}">
                                    W${i+1}
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            <table class="w-full text-sm leaderboard-table">
                                <thead>
                                    <tr>
                                        <th class="col-rank">排名</th>
                                        <th class="col-player">玩家</th>
                                        <th class="col-role">角色</th>
                                        <th class="col-level">等級</th>
                                        <th class="col-score">積分</th>
                                    </tr>
                                </thead>
                                <tbody class="text-slate-300">
                                    ${filteredData.length > 0 ? filteredData.map((d, i) => `
                                        <tr>
                                            <td class="font-bold text-center ${i < 3 ? 'text-yellow-400' : 'text-slate-500'}">#${i + 1}</td>
                                            <td class="truncate">${d.name}</td>
                                            <td class="truncate text-slate-400">${d.role}</td>
                                            <td class="text-center text-slate-400">Lv.${d.level}</td>
                                            <td class="text-right text-amber-500 font-mono font-bold">${d.score}</td>
                                        </tr>
                                    `).join('') : `<tr><td colspan="5" class="text-center py-8 text-slate-500">暫無資料，快去挑戰吧！</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            }

            content += `</main>`;
            
            if (showDebugButton) {
                content += `<button onclick="diagnoseConnection()" class="fixed bottom-4 right-4 p-2 bg-slate-800/80 hover:bg-slate-700 text-slate-400 text-xs rounded-full border border-slate-600 flex items-center gap-1 z-50">
                    <i data-lucide="wrench" class="w-3 h-3"></i> 測試連線
                </button>`;
            }

            app.innerHTML = content;
            lucide.createIcons();
            const logEl = document.getElementById('battle-log-container');
            if (logEl) logEl.scrollTop = logEl.scrollHeight;
        }

        function renderStart() {
            return `<div class="flex flex-col items-center justify-center h-full p-6 bg-slate-900 text-center animate-fade-in relative">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80')] bg-cover bg-center opacity-20 pointer-events-none"></div>
                <div class="z-10 bg-slate-900/90 p-8 rounded-2xl border-4 border-amber-600 shadow-2xl max-w-md w-full backdrop-blur-sm">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-yellow-200 mb-2 drop-shadow-sm">西寧探險家</h1>
                    <h2 class="text-xl text-amber-200 mb-6 font-serif tracking-widest">四界傳說</h2>
                    <div class="space-y-3">
                        <button onclick="toCharSelect()" class="w-full py-4 text-lg bg-amber-600 hover:bg-amber-500 text-white border-b-4 border-amber-800 rounded-lg font-bold shadow-md transition-all active:scale-95 animate-pulse flex items-center justify-center gap-2">
                            <i data-lucide="rocket"></i> 開始冒險
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="toggleLeaderboard()" class="py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 border-b-4 border-slate-900 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="trophy"></i> 英雄榜
                            </button>
                            <button onclick="toggleGameIntro()" class="py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 border-b-4 border-slate-900 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="book-open"></i> 遊戲介紹
                            </button>
                        </div>
                    </div>
                    <p class="text-slate-500 text-xs mt-6">穿梭於自然、社會與歷史的試煉！</p>
                </div>
            </div>`;
        }

        function renderCharSelect() {
            return `<div class="flex flex-col items-center p-6 h-full overflow-y-auto bg-slate-900">
                <div class="flex justify-between items-center w-full max-w-4xl mb-6">
                    <h2 class="text-2xl font-bold text-white">選擇角色</h2>
                    <button onclick="returnToMainMenu()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm border border-slate-600">返回主選單</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-4xl pb-4">
                    ${CHARACTERS.map(c => `
                    <button onclick="selectCharacter('${c.id}')" class="bg-slate-800 p-4 rounded-xl border-2 ${c.id==='book_immortal'?'border-amber-500/50 col-span-1 md:col-span-2':'border-slate-700 hover:border-amber-500'} text-left transition-all">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-2 rounded-full ${c.gender==='boy'?'bg-blue-900 text-blue-300':c.id==='book_immortal'?'bg-amber-900 text-amber-300':'bg-pink-900 text-pink-300'} flex items-center justify-center text-2xl h-12 w-12">
                                ${c.avatar || (c.id === 'book_immortal' ? '📖' : '👤')}
                            </div>
                            <span class="text-lg font-bold text-white">${c.name}</span>
                        </div>
                        <p class="text-sm text-slate-400 mb-2">${c.desc}</p>
                        <div class="text-xs text-amber-400 font-bold"><i data-lucide="sparkles" class="inline w-3 h-3"></i> ${c.abilityName}</div>
                    </button>`).join('')}
                </div>
            </div>`;
        }

        function renderMap() {
            const world = GAME_DATA.worlds[currentWorldIndex];
            let svg = '';
            const normalZones = world.zones.filter(z => !z.id.startsWith('boss'));
            const bossZone = world.zones.find(z => z.id.startsWith('boss'));
            
            // Draw lines from all normal zones to the boss to indicate requirement
            if (bossZone) {
                 const bossUnlocked = unlockZone(bossZone.id);
                 normalZones.forEach(z => {
                     const s = z.mapPos;
                     const e = bossZone.mapPos;
                     // Line is active if the specific normal zone is completed (contributing power to unlock boss)
                     const isZoneCompleted = player.completedZones.includes(z.id);
                     
                     // Use a subtle line style
                     svg += `<line x1="${s.left}" y1="${s.top}" x2="${e.left}" y2="${e.top}" stroke="${isZoneCompleted ? '#f59e0b' : '#334155'}" stroke-width="2" stroke-dasharray="${bossUnlocked ? '0' : '5,5'}" opacity="0.6" />`;
                 });
            }

            let html = `<div class="relative w-full h-full overflow-hidden flex flex-col"><div class="absolute top-4 left-4 z-10 text-white font-bold text-xl drop-shadow-md">${world.title}</div><div class="relative flex-1 bg-grid-pattern"><svg class="absolute inset-0 w-full h-full pointer-events-none z-0">${svg}</svg>`;
            
            world.zones.forEach((z, i) => {
                const unlocked = unlockZone(z.id), completed = player.completedZones.includes(z.id);
                const isNext = unlocked && !completed && player.role !== 'Guide';
                const isBoss = z.id.startsWith('boss');
                let cls = "w-14 h-14 rounded-full flex items-center justify-center border-4 shadow-xl cursor-pointer transition-all ";
                if (isBoss) cls += "w-16 h-16 "; 
                if (completed && player.role!=='Guide') cls += "bg-amber-100 border-amber-500 text-amber-600 scale-100";
                else if (isNext) cls += isBoss ? "bg-red-600 border-white text-white animate-pulse node-boss" : "bg-amber-600 border-white text-white animate-pulse node-pulse";
                else if (!unlocked) cls += "bg-slate-700 border-slate-600 text-slate-500 grayscale";
                else cls += isBoss ? "bg-red-900 border-red-500 text-red-500" : "bg-slate-800 border-amber-500 text-amber-500";

                html += `<div onclick="showZonePopup('${z.id}')" class="absolute transform -translate-x-1/2 -translate-y-1/2 z-10 flex flex-col items-center" style="top:${z.mapPos.top};left:${z.mapPos.left}">
                    <div class="${cls}"><i data-lucide="${completed && player.role!=='Guide' ? 'check-circle' : (!unlocked ? 'lock' : z.icon)}"></i></div>
                    <div class="mt-1 px-2 py-0.5 rounded text-[10px] font-bold shadow bg-slate-900 border border-slate-700 text-slate-200 whitespace-nowrap">${z.name}</div>
                </div>`;
            });

            if (showZoneInfo) {
                const z = showZoneInfo, idx = world.zones.findIndex(x => x.id === z.id);
                const btn = player.role === 'Guide' ? '查看攻略' : (player.completedZones.includes(z.id) ? '再次挑戰' : '開始挑戰');
                const isBoss = z.id.startsWith('boss');
                html += `<div class="absolute bottom-0 w-full bg-slate-900/95 border-t border-amber-500/30 p-6 rounded-t-2xl shadow-2xl z-50 animate-slide-up">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-slate-800 rounded-lg text-amber-500 border border-slate-700"><i data-lucide="${z.icon}"></i></div>
                            <div><h3 class="text-xl font-bold ${isBoss ? 'text-red-500' : 'text-white'}">${z.name}</h3><p class="text-xs text-amber-200/70">Lv.${idx+1}</p></div>
                        </div>
                        <button onclick="closeZonePopup()" class="text-slate-400">✕</button>
                    </div>
                    <p class="text-sm text-slate-300 mb-4">${z.description || (isBoss ? '包含本世界所有題目的終極試煉！' : '準備好迎接挑戰了嗎？')}</p>
                    <div class="flex flex-col gap-3">
                        <button onclick="enterZone('${z.id}')" class="w-full py-3 ${isBoss ? 'bg-red-600 hover:bg-red-500' : 'bg-amber-600 hover:bg-amber-500'} text-white rounded-lg font-bold">${btn}</button>
                        <button onclick="forgetClothes()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium text-sm">我只是忘了收衣服你等我</button>
                    </div>
                </div>`;
            }
            return html + `</div></div>`;
        }

        function renderGuide() {
            return `<div class="p-6 h-full flex flex-col"><div class="bg-slate-800 border-2 border-amber-500/50 rounded-xl p-6 flex-1 flex flex-col shadow-2xl relative overflow-hidden">
                <div class="flex items-center gap-3 border-b border-slate-700 pb-4 mb-4">
                    <i data-lucide="book-open" class="text-amber-400 w-8 h-8"></i>
                    <h2 class="text-2xl font-bold text-white">地質天書</h2>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 text-slate-300 leading-relaxed text-sm">
                    ${GUIDE_DATA[currentZone.id] || (currentZone.id.startsWith('boss') ? '<p>魔王關沒有攻略，這是對你綜合實力的考驗！</p>' : '無資料')}
                </div>
                <button onclick="returnToMap()" class="mt-4 w-full py-3 bg-slate-700 text-white rounded-lg font-bold">返回地圖</button>
            </div></div>`;
        }

        function renderBattle() {
            if (!currentQuestion) return '';
            const eHp = (currentEnemy.currentHp/225)*100; 
            const pHp = (player.hp/player.maxHp)*100;
            return `<div class="p-4 h-full flex flex-col gap-4 max-w-3xl mx-auto">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800 p-3 rounded-xl border border-red-900/50 relative overflow-hidden">
                        <div class="text-3xl mb-1 animate-bounce-custom">👾</div>
                        <div class="font-bold text-red-400">${currentEnemy.name}</div>
                        <div class="w-full bg-slate-900 h-2 rounded mt-1"><div class="bg-red-600 h-full rounded" style="width:${eHp}%"></div></div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-xl border border-blue-900/50 relative overflow-hidden">
                        <div class="text-3xl mb-1">🛡️</div>
                        <div class="font-bold text-blue-400">${player.name}</div>
                        <div class="w-full bg-slate-900 h-2 rounded mt-1"><div class="bg-green-500 h-full rounded" style="width:${pHp}%"></div></div>
                    </div>
                </div>
                <div id="battle-log-container" class="bg-black/40 p-3 rounded-lg h-32 overflow-y-auto text-sm text-slate-300 font-mono border border-slate-700/50">
                    ${battleLog.map(l=>`<div class="mb-1 border-l-2 border-slate-600 pl-2">${l}</div>`).join('')}
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-600 flex-1 flex flex-col justify-center">
                    <div class="mb-4"><h2 class="text-lg font-bold text-white">${currentQuestion.q}</h2></div>
                    <div class="grid grid-cols-1 gap-2">
                        ${currentQuestion.shuffledOptions.map((o,i)=>`<button onclick="handleAnswer(${i})" class="p-3 bg-slate-700 hover:bg-slate-600 text-left rounded text-slate-100 font-medium active:scale-95 transition-transform"><span class="text-amber-500 mr-2 font-bold">${String.fromCharCode(65+i)}.</span>${o}</button>`).join('')}
                    </div>
                </div>
            </div>`;
        }

        function renderVictory() {
            // 判斷是否已經上傳過戰績
            const isUploaded = player.uploadedZones.includes(currentZone.id);
            const uploadBtn = isUploaded 
                ? `<button disabled class="px-8 py-3 bg-slate-700 text-slate-500 rounded-lg font-bold shadow-lg cursor-not-allowed">已上傳</button>`
                : `<button onclick="uploadScore()" class="px-8 py-3 bg-amber-600 text-white rounded-lg font-bold shadow-lg animate-pulse">上傳戰績</button>`;

            const currentWorldScore = player.worldScores[currentWorldIndex] || 0;

            return `<div class="flex flex-col items-center justify-center h-full p-6 text-center animate-fade-in">
                <div class="text-6xl mb-4 animate-bounce-custom">🏆</div>
                <h1 class="text-3xl font-bold text-green-400 mb-2">攻略成功！</h1>
                <p class="text-slate-400 mb-6">你通過了 ${currentZone.name} 的試煉。</p>
                
                <div class="bg-slate-800 p-4 rounded-xl mb-8 w-full max-w-sm border border-slate-700">
                    <h3 class="text-lg font-bold text-white mb-3">本次戰報</h3>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">⏱️ 耗時</span>
                        <span class="font-mono text-white">${battleStats.duration} 秒</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">🎯 答對率</span>
                        <span class="font-mono text-white">${battleStats.accuracy}%</span>
                    </div>
                     <div class="flex justify-between items-center mb-2 border-t border-slate-700 pt-2">
                        <span class="text-amber-200">➕ 本關得分</span>
                        <span class="font-mono text-white font-bold">+${battleStats.score}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-amber-500 font-bold">✨ 本世界總分</span>
                        <span class="font-mono text-2xl text-amber-400 font-bold">${currentWorldScore}</span>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="returnToMap()" class="px-8 py-3 bg-slate-600 text-white rounded-lg font-bold shadow-lg">返回地圖</button>
                    ${player.role !== 'Guide' ? uploadBtn : ''}
                </div>
            </div>`;
        }

        function renderGameOver() {
            return `<div class="flex flex-col items-center justify-center h-full p-6 text-center animate-fade-in">
                <div class="text-6xl mb-4">☠️</div>
                <h1 class="text-3xl font-bold text-red-500 mb-2">探索失敗...</h1>
                <button onclick="restartGame()" class="px-8 py-3 bg-red-800 text-white rounded-lg font-bold shadow-lg">重新開始</button>
            </div>`;
        }

        renderApp();
    </script>
</body>
</html>
