<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¥¿å¯§æ¢éšªå®¶ï¼šå››ç•Œå‚³èªª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            touch-action: manipulation;
            background-color: #0f172a;
            color: #f1f5f9;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes bounce-custom { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
        .animate-bounce-custom { animation: bounce-custom 1s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); } 50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); } }
        .node-pulse { animation: pulse-glow 2s infinite; }
        @keyframes boss-pulse { 0%, 100% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.6); transform: scale(1); } 50% { box-shadow: 0 0 30px rgba(220, 38, 38, 0.9); transform: scale(1.1); } }
        .node-boss { animation: boss-pulse 3s infinite; }

        /* æˆ°é¬¥å‹•ç•« */
        @keyframes attack-right { 0% { transform: translateX(0); } 50% { transform: translateX(60px) rotate(10deg); } 100% { transform: translateX(0); } }
        @keyframes attack-left { 0% { transform: translateX(0); } 50% { transform: translateX(-60px) rotate(-10deg); } 100% { transform: translateX(0); } }
        @keyframes damage-shake { 
            0% { transform: translate(0, 0); filter: none; } 
            20% { transform: translate(-10px, 0); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 
            40% { transform: translate(10px, 0); } 
            60% { transform: translate(-10px, 0); } 
            80% { transform: translate(10px, 0); } 
            100% { transform: translate(0, 0); filter: none; } 
        }
        @keyframes float-up { 
            0% { opacity: 1; transform: translateY(0) scale(1); } 
            100% { opacity: 0; transform: translateY(-80px) scale(1.5); } 
        }

        .anim-attack-p { animation: attack-right 0.4s ease-in-out; z-index: 10; }
        .anim-attack-e { animation: attack-left 0.4s ease-in-out; z-index: 10; }
        .anim-damage { animation: damage-shake 0.5s ease-in-out; }
        .anim-float-text { position: absolute; animation: float-up 1s ease-out forwards; font-weight: 900; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 20; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .bg-grid-pattern { background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 30px 30px; }
        
        .guide-content h3 { color: #fbbf24; font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.25rem; }
        .guide-content h3:first-child { margin-top: 0; }
        .guide-content p { margin-bottom: 0.5rem; color: #cbd5e1; line-height: 1.6; font-size: 0.95rem; }
        .guide-content strong { color: #fff; font-weight: 900; }
        .guide-content .highlight { color: #f472b6; font-weight: bold; }
        .guide-content ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; color: #94a3b8; font-size: 0.9rem; }
        .guide-content li { margin-bottom: 0.25rem; }

        /* Leaderboard Table Alignment */
        .leaderboard-table { table-layout: fixed; }
        .leaderboard-table th { @apply text-left p-3 text-amber-500 border-b border-slate-600 font-bold bg-slate-800; }
        .leaderboard-table td { @apply p-3 border-b border-slate-700/50 truncate; }
        .leaderboard-table tr:hover { @apply bg-slate-800/50; }
        .col-rank { width: 15%; text-align: center; }
        .col-player { width: 30%; }
        .col-role { width: 30%; }
        .col-level { width: 15%; text-align: center; }
        .col-score { width: 10%; text-align: right; }
    </style>
</head>
<body class="overflow-hidden select-none h-screen flex flex-col">

    <div id="app" class="w-full h-full flex flex-col relative"></div>

    <!-- UI Components (Modal & Toast) -->
    <div id="custom-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border-2 border-amber-500 rounded-xl max-w-md w-full p-6 shadow-2xl transform scale-100 transition-transform animate-fade-in flex flex-col max-h-[80vh]">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4 flex-shrink-0">æ¨™é¡Œ</h3>
            <div id="modal-content" class="mb-6 text-slate-300 overflow-y-auto flex-1 text-sm whitespace-pre-wrap">å…§å®¹</div>
            <div id="modal-input-container" class="mb-4 hidden flex-shrink-0">
                <input type="text" id="modal-input" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white focus:border-amber-500 outline-none" placeholder="">
            </div>
            <div class="flex justify-end gap-3 flex-shrink-0">
                <button id="modal-cancel" class="px-4 py-2 text-slate-400 hover:text-white rounded">å–æ¶ˆ</button>
                <button id="modal-confirm" class="px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded font-bold">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="custom-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-amber-500 text-white px-6 py-3 rounded-full shadow-2xl z-[110] hidden opacity-0 transition-opacity duration-300 flex items-center gap-2">
        <i data-lucide="info" class="w-5 h-5 text-amber-500"></i>
        <span id="toast-message" class="font-bold">è¨Šæ¯</span>
    </div>

    <script>
        // --- è¨­å®š ---
        // æ‚¨çš„å°ˆå±¬ GAS å¾Œç«¯ç¶²å€
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxUjnGfXcFhDSSfWCHUvRhSgoZ_lY_Bd2l-50O5i3KSKMq88Rjhpaq2Tc_jDQppe_tiUQ/exec";
        
        // --- UI UTILS ---
        function showModal({ title, message, inputPlaceholder, inputValue, showCancel = true, onConfirm }) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = message || '';
            
            const inputContainer = document.getElementById('modal-input-container');
            const input = document.getElementById('modal-input');
            
            if (inputPlaceholder !== undefined) {
                inputContainer.classList.remove('hidden');
                // å¦‚æœæœ‰æä¾›é è¨­å€¼å°±å¡«å…¥ï¼Œå¦å‰‡æ¸…ç©º
                input.value = inputValue !== undefined ? inputValue : '';
                input.placeholder = inputPlaceholder;
                setTimeout(() => input.focus(), 100);
            } else {
                inputContainer.classList.add('hidden');
            }

            const cancelBtn = document.getElementById('modal-cancel');
            if (showCancel) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => { modal.classList.add('hidden'); };
            } else {
                cancelBtn.classList.add('hidden');
            }

            const confirmBtn = document.getElementById('modal-confirm');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                const val = input.value;
                if(inputPlaceholder !== undefined && !val) return;
                modal.classList.add('hidden');
                if (onConfirm) onConfirm(val);
            };

            modal.classList.remove('hidden');
        }

        function showToast(msg) {
            const toast = document.getElementById('custom-toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('hidden');
            void toast.offsetWidth; 
            toast.classList.remove('opacity-0');
            lucide.createIcons();
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- CHARACTERS ---
        const CHARACTERS = [
            { id: 'kegui', name: 'é­”æ³•å¸«ç§‘è²´', gender: 'boy', role: 'Mage', desc: 'è¥¿å¯§åœ‹å°æ™ºåŠ›æ“”ç•¶ï¼Œæ“…é•·å¿«é€Ÿå¸æ”¶çŸ¥è­˜ã€‚', abilityName: 'åšå­¸å¤šè', abilityDesc: 'ç­”å°å•é¡Œç²å¾—çš„ç¶“é©—å€¼ +30%', stats: { hp: 100, xpBonus: 1.3, dmgReduction: 0, healOnHit: 0 }, avatar: 'ğŸ§™â€â™‚ï¸' },
            { id: 'chongyi', name: 'é‡è »äººå´‡äº¦', gender: 'boy', role: 'Barbarian', desc: 'é«”è‚²èª²çš„ç‹è€…ï¼Œæ“æœ‰é©šäººçš„é«”åŠ›ã€‚', abilityName: 'è »è’é«”é­„', abilityDesc: 'åˆå§‹ HP é«˜é” 130', stats: { hp: 130, xpBonus: 1.0, dmgReduction: 0, healOnHit: 0 }, avatar: 'ğŸ‹ï¸' },
            { id: 'peiyu', name: 'éº»æ³•å¸«å§µå¦¤', gender: 'girl', role: 'Mage', desc: 'å¿ƒæ€ç´°è†©ï¼Œæ‡‚å¾—å¦‚ä½•åœ¨æˆ°é¬¥ä¸­ä¿è­·è‡ªå·±ã€‚', abilityName: 'å…ƒç´ æ²»ç™’', abilityDesc: 'ç­”å°å•é¡Œæ™‚å›å¾© 5 é» HP', stats: { hp: 100, xpBonus: 1.0, dmgReduction: 0, healOnHit: 5 }, avatar: 'ğŸ§šâ€â™€ï¸' },
            { id: 'yunqi', name: 'å¥³æˆ°å£«å¦˜è', gender: 'girl', role: 'Warrior', desc: 'äºé¦¬éœçš„å¾Œè£”ï¼Œæ“…é•·é˜²ç¦¦æ•µäººçš„æ”»æ“Šã€‚', abilityName: 'æˆ°é¬¥æ ¼æ“‹', abilityDesc: 'ç­”éŒ¯æ™‚å—åˆ°çš„å‚·å®³æ¸›å°‘ 5 é»', stats: { hp: 110, xpBonus: 1.0, dmgReduction: 5, healOnHit: 0 }, avatar: 'ğŸ§â€â™€ï¸' },
            { id: 'youchen', name: 'æ­»éˆæ³•å¸«ä½‘è¾°', gender: 'boy', role: 'Necromancer', desc: 'ä¾†è‡ªå¹½å†¥çš„å¬å–šå¸«ï¼Œèƒ½å¾ç­”é¡Œä¸­æ±²å–ç”Ÿå‘½èƒ½é‡ã€‚', abilityName: 'éˆé­‚æ±²å–', abilityDesc: 'ç­”å°å•é¡Œå›å¾© 10 é» HP', stats: { hp: 90, xpBonus: 1.0, dmgReduction: 0, healOnHit: 10 }, avatar: 'ğŸ’€' },
            { id: 'bingjia', name: 'ä¸€æ‹³è¶…äººç§‰å®¶', gender: 'boy', role: 'Hero', desc: 'èˆˆè¶£æ˜¯ç•¶è‹±é›„ï¼Œæ¯å¤©éƒ½åš100ä¸‹ä¼åœ°æŒºèº«ã€‚', abilityName: 'èªçœŸç­”é¡Œ', abilityDesc: 'ç­”å°é€ æˆ 25 é»å‚·å®³ (ä¸€èˆ¬ç‚º15)', stats: { hp: 100, xpBonus: 1.0, dmgReduction: 0, healOnHit: 0, dmgBonus: 10 }, avatar: 'ğŸ‘Š' },
            { id: 'book_immortal', name: 'è¥¿å¯§æ›¸ä»™è€é ­', gender: 'elder', role: 'Guide', desc: 'å‚³èªªä¸­éš±å±…åœ¨åœ–æ›¸é¤¨æ·±è™•çš„è€è€…ï¼ŒçŸ¥æ›‰æ‰€æœ‰å¥§ç¥•ã€‚', abilityName: 'è¬å·å¤©æ›¸', abilityDesc: 'ç„¡æ³•æˆ°é¬¥èˆ‡ç­”é¡Œï¼Œä½†èƒ½æŸ¥çœ‹æ‰€æœ‰é—œå¡çš„é‡é»æ”»ç•¥ã€‚', stats: { hp: 1, xpBonus: 0, dmgReduction: 0, healOnHit: 0 }, avatar: 'ğŸ‘´' }
        ];

        // --- GUIDE DATA ---
        const GUIDE_DATA = {
            'river': `<div class="guide-content"><h3>1. ä¸Šæ¸¸ï¼šé™¡å³­èˆ‡ä¾µè•</h3><p>æ²³æµä¸Šæ¸¸å°±åƒæºœæ»‘æ¢¯çš„é ‚ç«¯ï¼Œåœ°å‹¢å¾ˆé™¡ï¼Œæ°´æµ<strong>éå¸¸æ€¥</strong>ã€‚</p><ul><li><strong>ä½œç”¨åŠ›</strong>ï¼šæ°´æµå¤ªå¿«äº†ï¼ŒæŠŠçŸ³é ­æ²–åˆ·ä¸‹ä¾†ï¼ˆ<span class="highlight">ä¾µè•ä½œç”¨</span>ï¼‰ä¸¦æ¬é‹èµ°ï¼ˆ<span class="highlight">æ¬é‹ä½œç”¨</span>ï¼‰ã€‚</li><li><strong>åœ°å½¢</strong>ï¼šVå‹è°·ã€å³½è°·ï¼ˆå¤ªé­¯é–£ï¼‰ã€ç€‘å¸ƒã€å£ºç©´ã€‚</li></ul><h3>2. ä¸­æ¸¸ï¼šè®Šå¯¬èˆ‡æ¬é‹</h3><p>æ°´æµåˆ°äº†ä¸­é–“ï¼Œé€Ÿåº¦ç¨å¾®æ…¢ä¸€é»é»ï¼Œä½†é‚„æ˜¯èƒ½æ¬æ±è¥¿ã€‚</p><ul><li><strong>çŸ³é ­</strong>ï¼šçŸ³é ­åœ¨æ»¾å‹•éç¨‹ä¸­äº’ç›¸ç¢°æ’ï¼Œå°–è§’è¢«ç£¨æ‰äº†ï¼Œè®Šæˆåœ“åœ“èƒ–èƒ–çš„<span class="highlight">éµåµçŸ³</span>ã€‚</li><li><strong>æ›²æµ</strong>ï¼šæ²³é“å½å½æ›²æ›²çš„ã€‚<ul><li><strong>å‡¹å²¸</strong>ï¼šæ°´æµæ²–å‘é€™é‚Šï¼Œæ°´å¿«ã€æ°´æ·±ï¼Œç™¼ç”Ÿ<span class="highlight">ä¾µè•ä½œç”¨</span>ï¼ˆåœ°åŸºæœƒè¢«æç©ºï¼Œå±éšªï¼ï¼‰ã€‚</li><li><strong>å‡¸å²¸</strong>ï¼šæ°´æµæµéé€™é‚Šè®Šæ…¢ï¼Œç™¼ç”Ÿ<span class="highlight">å †ç©ä½œç”¨</span>ï¼ˆè®Šæˆæ²™ç˜ï¼Œé©åˆç©æ°´ï¼‰ã€‚</li></ul></li></ul><h3>3. ä¸‹æ¸¸ï¼šå¹³å¦èˆ‡å †ç©</h3><p>å¿«åˆ°å¤§æµ·äº†ï¼Œåœ°å‹¢è®Šå¹³ï¼Œæ°´æµ<strong>è®Šæ…¢</strong>ï¼Œæ¬ä¸å‹•æ±è¥¿äº†ã€‚</p><ul><li><strong>ä½œç”¨åŠ›</strong>ï¼šæ³¥æ²™é€šé€šæ”¾ä¸‹ä¾†ï¼Œå«åš<span class="highlight">å †ç©ä½œç”¨</span>ã€‚</li><li><strong>åœ°å½¢</strong>ï¼šå½¢æˆå¯¬å»£çš„<strong>æ²–ç©å¹³åŸ</strong>ï¼ˆæˆ‘å€‘ä½çš„åœ°æ–¹ï¼‰ã€‚åœ¨å‡ºæµ·å£æœƒå †æˆ<span class="highlight">ä¸‰è§’æ´²</span>ã€‚</li><li><strong>çŸ³é ­</strong>ï¼šå‰©ä¸‹ç´°ç´°çš„<strong>æ³¥æ²™</strong>ã€‚</li></ul></div>`,
            'coast': `<div class="guide-content"><h3>1. æµ·æµªçš„é›•åˆ»å¸«ï¼šæµ·è•åœ°å½¢</h3><p>æµ·æµªä¸æ–·æ‹æ‰“å²©çŸ³ï¼ŒæŠŠçŸ³é ­ã€Œç£¨æ‰ã€æˆ–ã€Œæ‰“ç©¿ã€ï¼Œé€™å°±æ˜¯<span class="highlight">ä¾µè•ä½œç”¨</span>ã€‚</p><ul><li><strong>è±†è…å²©</strong>ï¼šå²©çŸ³æœ‰ç¯€ç†ï¼ˆè£‚ç¸«ï¼‰ï¼Œæµ·æ°´æ²¿è‘—è£‚ç¸«åˆ‡ä¸‹å»ï¼Œåˆ‡æˆä¸€å¡Šå¡Šåƒè±†è…ï¼ˆåŸºéš†å’Œå¹³å³¶ï¼‰ã€‚</li><li><strong>è•ˆç‹€å²©</strong>ï¼šä¾‹å¦‚<span class="highlight">å¥³ç‹é ­</span>ã€‚ä¸Šé¢çŸ³é ­ç¡¬ï¼Œä¸‹é¢çŸ³é ­è»Ÿï¼Œä¸‹é¢çš„è„–å­è¢«é¢¨å’Œæµ·æ°´ç£¨ç´°äº†ï¼ˆå·®ç•°ä¾µè•ï¼‰ã€‚</li><li><strong>æ¼”è®Šéç¨‹</strong>ï¼šæµ·è•æ´ï¼ˆæŒ–ä¸€å€‹æ´ï¼‰â†’ <span class="highlight">æµ·è•é–€/æ‹±é–€</span>ï¼ˆæ‰“ç©¿äº†ï¼‰â†’ <span class="highlight">æµ·è•æŸ±</span>ï¼ˆé ‚éƒ¨å¡Œäº†å‰©æŸ±å­ï¼‰ã€‚</li><li><strong>è€æ¢…ç¶ çŸ³æ§½</strong>ï¼šæ˜¯<span class="highlight">æµ·è•æº</span>ï¼Œä¸Šé¢é•·æ»¿äº†ç¶ è—»ã€‚</li></ul><h3>2. æµ·æµªçš„æ¬é‹å·¥ï¼šæµ·ç©åœ°å½¢</h3><p>æµ·æµªæŠŠæ²™å­æ¬ä¾†æ¬å»ï¼Œå †åœ¨å²¸é‚Šï¼Œé€™å°±æ˜¯<span class="highlight">å †ç©ä½œç”¨</span>ã€‚</p><ul><li><strong>æ²™ç˜</strong>ï¼šç¦éš†æµ·æ°´æµ´å ´é‡‘é»ƒè‰²çš„æ²™ç˜ã€‚</li><li><strong>æ²™æ´²</strong>ï¼šå †ç©åœ¨æµ·ä¸­é–“é•·é•·çš„ä¸€æ¢æ²™å­ï¼ˆåƒé¯¤é¯“ï¼‰ã€‚</li><li><strong>æ½Ÿæ¹–</strong>ï¼šè¢«æ²™æ´²æ“‹ä½ï¼Œåœ¨å…§å´å¹³éœçš„æ°´åŸŸï¼ˆåƒä¸ƒè‚¡æ½Ÿæ¹–ï¼Œé©åˆé¤Šèšµï¼‰ã€‚</li><li><strong>é™¸é€£å³¶</strong>ï¼šæ²™å­å †ç©æŠŠå°å³¶å’Œé™¸åœ°é€£èµ·ä¾†äº†ï¼ˆå°æ±é‡‘æ¨½ï¼‰ã€‚</li></ul></div>`,
            'rocks': `<div class="guide-content"><h3>1. å²©çŸ³ä¸‰å¤§å®¶æ—</h3><p>å²©çŸ³ä¾ç…§ã€Œæ€éº¼å½¢æˆçš„ã€åˆ†æˆä¸‰å¤§é¡ï¼š</p><ul><li><strong>ç«æˆå²©</strong>ï¼ˆç«æ°£å¾ˆå¤§ï¼‰ï¼šå²©æ¼¿å†·å»è®Šæˆçš„ã€‚<ul><li><span class="highlight">å®‰å±±å²©</span>ï¼šå¾ˆç¡¬ï¼Œå¸¸æ‹¿ä¾†åšå»Ÿå®‡çš„çŸ³ç…ã€é¾æŸ±ã€‚</li><li><span class="highlight">ç„æ­¦å²©</span>ï¼šé»‘é»‘çš„ï¼Œæœ‰æ°£å­”ï¼ˆå²©æ¼¿æ°£é«”è·‘æ‰ï¼‰ï¼Œæ¾æ¹–æœ€å¤šã€‚</li><li><span class="highlight">èŠ±å´—å²©</span>ï¼šæœ‰é»‘ã€ç™½ã€è‚‰ç´…ä¸‰ç¨®é¡è‰²é¡†ç²’ï¼ˆé»‘é›²æ¯ã€çŸ³è‹±ã€é•·çŸ³ï¼‰ï¼Œåšåœ°æ¿å¸¸ç”¨ã€‚</li></ul></li><li><strong>æ²‰ç©å²©</strong>ï¼ˆå±¤å±¤å †ç–Šï¼‰ï¼šæ³¥æ²™ä¸€å±¤å±¤å †èµ·ä¾†å£“å¯¦çš„ã€‚<ul><li><span class="highlight">çŸ³ç°å²©</span>ï¼šä»¥å‰æ˜¯çŠç‘šç¤ï¼Œæ»´åˆ°<strong>ç¨€é¹½é…¸</strong>æœƒå†’æ³¡æ³¡ï¼ˆç”¢ç”ŸäºŒæ°§åŒ–ç¢³ï¼‰ï¼Œæ˜¯åšæ°´æ³¥çš„åŸæ–™ã€‚</li><li><strong>åŒ–çŸ³</strong>ï¼šæœ€å®¹æ˜“åœ¨æ²‰ç©å²©è£¡ç™¼ç¾åŒ–çŸ³ï¼</li></ul></li><li><strong>è®Šè³ªå²©</strong>ï¼ˆå£“åŠ›å±±å¤§ï¼‰ï¼šå²©çŸ³è¢«é«˜æº«é«˜å£“ã€Œçƒ¤ã€éè®Šå½¢äº†ã€‚<ul><li><span class="highlight">å¤§ç†å²©</span>ï¼šç”±çŸ³ç°å²©è®Šä¾†çš„ï¼Œæœ‰ç¾éº—èŠ±ç´‹ã€‚</li><li><span class="highlight">æ¿å²©</span>ï¼šç”±é å²©è®Šä¾†çš„ï¼ŒåŸä½æ°‘æ‹¿ä¾†è“‹çŸ³æ¿å±‹ã€‚</li></ul></li></ul><h3>2. ç¤¦ç‰©æ¯”ä¸€æ¯”</h3><ul><li><strong>ç¡¬åº¦</strong>ï¼ˆèª°æœ€ç¡¬ï¼Ÿï¼‰ï¼š<span class="highlight">æ»‘çŸ³</span>ï¼ˆæœ€è»Ÿï¼‰ < æŒ‡ç”² < <span class="highlight">æ–¹è§£çŸ³</span>ï¼ˆéŠ…å¹£ï¼‰ < <span class="highlight">çŸ³è‹±</span>ï¼ˆæ¯”ç»ç’ƒç¡¬ï¼‰ < <span class="highlight">é‡‘å‰›çŸ³</span>ï¼ˆé‘½çŸ³ï¼Œæœ€ç¡¬ï¼‰ã€‚</li><li><strong>ç‰¹æ€§</strong>ï¼š<ul><li><strong>ç¡«ç£º</strong>ï¼šé»ƒè‰²ï¼Œæœ‰è‡­é›è›‹å‘³ï¼Œåšç«è—¥ã€‚</li><li><strong>çŸ³å¢¨</strong>ï¼šé»‘è‰²ï¼Œæœƒå°é›»ï¼Œåšé‰›ç­†èŠ¯ã€‚</li><li><strong>æ»‘çŸ³</strong>ï¼šæ‘¸èµ·ä¾†æ»‘æ»‘çš„ï¼Œåšçˆ½èº«ç²‰ã€‚</li></ul></li></ul></div>`,
            'disaster': `<div class="guide-content"><h3>1. åœ°éœ‡çš„å¤§å°æ€éº¼çœ‹ï¼Ÿ</h3><p>åœ°éœ‡å ±å‘Šæœƒçœ‹åˆ°å…©å€‹é‡è¦çš„æ•¸å­—ï¼Œåƒè¬åˆ¥ææ··ï¼</p><ul><li><span class="highlight">èŠ®æ°è¦æ¨¡</span>ï¼šä»£è¡¨åœ°éœ‡é‡‹æ”¾çš„<strong>èƒ½é‡å¤§å°</strong>ã€‚<ul><li>å…¨å°ç£<strong>åªæœ‰ä¸€å€‹æ•¸å€¼</strong>ã€‚</li><li>æœ‰å°æ•¸é»ï¼Œæ²’æœ‰å–®ä½ã€‚</li></ul></li><li><span class="highlight">éœ‡åº¦</span>ï¼šä»£è¡¨ä½ æ„Ÿè¦ºåˆ°çš„<strong>æ–æ™ƒç¨‹åº¦</strong>ã€‚<ul><li><strong>å„åœ°ä¸åŒ</strong>ã€‚</li><li>åˆ†ç´šï¼š0ç´šï¼ˆç„¡æ„Ÿï¼‰~ 7ç´šï¼ˆåŠ‡çƒˆï¼‰ï¼Œå…±10å€‹ç­‰ç´šã€‚</li></ul></li></ul><h3>2. åœ°éœ‡ä¾†äº†æ€éº¼è¾¦ï¼Ÿ</h3><ul><li><strong>ä¿å‘½ä¸‰æ­¥é©Ÿ</strong>ï¼š<span class="highlight">è¶´ä¸‹ã€æ©è­·ã€ç©©ä½</span>ã€‚</li><li><strong>ä¸å¯ä»¥</strong>ï¼šæ­é›»æ¢¯ã€æ…Œå¼µäº‚è·‘ã€é»ç«ã€‚</li><li><strong>ç·Šæ€¥é¿é›£åŒ…</strong>ï¼šè¦æ”¾ä¹¾ç³§ã€æ°´ã€æ‰‹é›»ç­’ã€é›»æ± ã€å“¨å­ã€è­‰ä»¶ã€ä¿æš–è¡£ç‰©ã€‚</li></ul></div>`,
            'magnet1': `<div class="guide-content"><h3>1. ç£éµçš„å€‹æ€§</h3><ul><li><strong>ç£æ¥µ</strong>ï¼šç£åŠ›æœ€å¼·çš„åœ°æ–¹åœ¨<strong>å…©ç«¯</strong>ï¼ˆNæ¥µå’ŒSæ¥µï¼‰ã€‚</li><li><strong>ç›¸è™•ä¹‹é“</strong>ï¼š<span class="highlight">åŒæ¥µç›¸æ–¥</span>ï¼Œ<span class="highlight">ç•°æ¥µç›¸å¸</span>ã€‚</li></ul><h3>2. åœ°çƒå°±æ˜¯å¤§ç£éµ</h3><ul><li><strong>æŒ‡åŒ—é‡åŸç†</strong>ï¼šæŒ‡åŒ—é‡çš„ç®­é ­æ˜¯Næ¥µã€‚å› ç‚ºç•°æ¥µç›¸å¸ï¼Œå®ƒæœƒè¢«åœ°çƒçš„ç£å ´å¸å¼•ã€‚</li><li><strong>é‡è¦è§€å¿µ</strong>ï¼šåœ°ç†çš„åŒ—æ¥µé™„è¿‘ï¼Œå…¶å¯¦æ˜¯<span class="highlight">åœ°ç£çš„Sæ¥µ</span>ï¼›åœ°ç†çš„å—æ¥µé™„è¿‘ï¼Œæ˜¯<span class="highlight">åœ°ç£çš„Næ¥µ</span>ã€‚</li></ul></div>`,
            'magnet2': `<div class="guide-content"><h3>1. é›»ä¹Ÿèƒ½ç”Ÿç£</h3><ul><li><strong>å¥§æ–¯ç‰¹çš„ç™¼ç¾</strong>ï¼šé€šé›»çš„é›»ç·šæ—é‚Šï¼ŒæŒ‡åŒ—é‡æœƒåè½‰ï¼</li><li><strong>å®‰åŸ¹å³æ‰‹å®šå‰‡</strong>ï¼ˆç°¡å–®ç‰ˆï¼‰ï¼š<ul><li>é›»ç·šæ”¾åœ¨æŒ‡åŒ—é‡<strong>ä¸Šæ–¹</strong> vs <strong>ä¸‹æ–¹</strong>ï¼ŒæŒ‡é‡åè½‰æ–¹å‘æœƒ<span class="highlight">ç›¸å</span>ã€‚</li><li>é›»æµæ–¹å‘æ”¹è®Šï¼ŒæŒ‡é‡åè½‰æ–¹å‘ä¹Ÿæœƒ<span class="highlight">ç›¸å</span>ã€‚</li></ul></li></ul><h3>2. è¶…ç´šé›»ç£éµ</h3><p>æ€éº¼è®“é›»ç£éµè®Šå¼·ï¼Ÿ</p><ul><li><strong>åŠ å¼·æ³• 1</strong>ï¼š<span class="highlight">ä¸²è¯é›»æ± </span>ã€‚</li><li><strong>åŠ å¼·æ³• 2</strong>ï¼š<span class="highlight">å¢åŠ ç·šåœˆåœˆæ•¸</span>ã€‚</li><li><strong>åŠ å¼·æ³• 3</strong>ï¼šç·šåœˆè£¡é¢æ”¾å…¥<span class="highlight">éµæ£’</span>ã€‚</li></ul></div>`,
            'magnet3': `<div class="guide-content"><h3>1. ç”Ÿæ´»ä¸­çš„é¦¬é”</h3><ul><li><strong>åŸç†</strong>ï¼šåˆ©ç”¨<span class="highlight">åŒæ¥µç›¸æ–¥ã€ç•°æ¥µç›¸å¸</span>çš„åŸç†ï¼Œè®“è»¸å¿ƒè½‰å‹•ã€‚</li><li><strong>æ‡‰ç”¨</strong>ï¼š<span class="highlight">é›»é¢¨æ‰‡ã€æ´—è¡£æ©Ÿã€å¹é¢¨æ©Ÿ</span>ã€‚</li></ul><h3>2. ç£æµ®åˆ—è»Š</h3><ul><li><strong>åŸç†</strong>ï¼šåˆ©ç”¨ç£åŠ›è®“è»Šé«”<span class="highlight">æ‡¸æµ®</span>ã€‚</li><li><strong>å„ªé»</strong>ï¼š<span class="highlight">æ²’æœ‰æ‘©æ“¦åŠ›</span>ï¼Œé€Ÿåº¦å¿«ã€å™ªéŸ³å°ã€‚</li></ul></div>`,
            'solution1': `<div class="guide-content"><h3>1. æº¶è§£</h3><ul><li>ç‰©è³ªåœ¨æ°´ä¸­æ¶ˆå¤±ï¼Œçœ‹ä¸è¦‹é¡†ç²’ï¼Œé€™å°±æ˜¯<span class="highlight">æº¶è§£</span>ã€‚</li><li><strong>é‡é‡å®ˆæ†</strong>ï¼šæº¶è§£å¾Œï¼Œé‡é‡ä¸æœƒè®Šè¼•ï¼</li></ul><h3>2. åŠ é€Ÿæº¶è§£</h3><ul><li><strong>æ”ªæ‹Œã€åŠ ç†±ã€ç£¨ç¢</strong>ã€‚</li></ul><h3>3. é£½å’Œèˆ‡åˆ†é›¢</h3><ul><li><strong>é£½å’Œ</strong>ï¼šåƒä¸ä¸‹äº†ï¼æ°´å†ä¹Ÿæº¶ä¸é€²å»é¹½å·´ã€‚</li><li><strong>åˆ†é›¢</strong>ï¼šåˆ©ç”¨<strong>è’¸ç™¼</strong>ï¼ˆæ™’å¤ªé™½ã€åŠ ç†±ï¼‰æŠŠæ°´è¶•èµ°ï¼Œç•™ä¸‹é¹½çµæ™¶ã€‚</li></ul></div>`,
            'solution2': `<div class="guide-content"><h3>1. çŸ³è•Šè©¦ç´™</h3><p>å£è¨£ï¼š<span class="highlight">é…¸ç´…é¹¼è—</span></p><ul><li><strong>é…¸æ€§</strong>ï¼šè®Š<span class="highlight">ç´…è‰²</span>ã€‚</li><li><strong>é¹¼æ€§</strong>ï¼šè®Š<span class="highlight">è—è‰²</span>ã€‚</li></ul><h3>2. å¸¸è¦‹æ°´æº¶æ¶²</h3><ul><li><strong>é…¸æ€§</strong>ï¼š<span class="highlight">æª¸æª¬æ±ã€ç™½é†‹ã€æ±½æ°´</span>ã€‚</li><li><strong>é¹¼æ€§</strong>ï¼š<span class="highlight">å°è˜‡æ‰“æ°´ã€çŸ³ç°æ°´ã€æ°¨æ°´ã€è‚¥çš‚æ°´</span>ã€‚</li><li><strong>ä¸­æ€§</strong>ï¼š<span class="highlight">é£Ÿé¹½æ°´ã€ç³–æ°´</span>ã€‚</li></ul></div>`,
            'solution3': `<div class="guide-content"><h3>1. å°é›»æ€§</h3><p>èƒ½å°é›»çš„æ°´æº¶æ¶²ç¨±ç‚º<span class="highlight">é›»è§£è³ª</span>ã€‚</p><ul><li><strong>å®¹æ˜“å°é›»</strong>ï¼šé…¸ã€é¹¼ã€é¹½é¡ï¼ˆæª¸æª¬æ±ã€é£Ÿé¹½æ°´ï¼‰ã€‚</li><li><strong>ä¸æ˜“å°é›»</strong>ï¼šç³–æ°´ã€é…’ç²¾ã€ç´”æ°´ã€‚</li></ul><h3>2. å®‰å…¨</h3><p><span class="highlight">æ‰‹æº¼æº¼çš„çµ•å°ä¸èƒ½ç¢°é›»å™¨é–‹é—œ</span>ã€‚</p></div>`,
            'force1': `<div class="guide-content"><h3>1. åŠ›æ˜¯ä»€éº¼ï¼Ÿ</h3><p>åŠ›å¯ä»¥é€ æˆï¼šç§»å‹•ã€æ”¹è®Šæ–¹å‘ã€è®Šå½¢ã€æ”¹è®Šå¿«æ…¢ã€‚</p><h3>2. æ¥è§¸åŠ› vs è¶…è·åŠ›</h3><ul><li><strong>æ¥è§¸åŠ›</strong>ï¼šæ¨åŠ›ã€æ‘©æ“¦åŠ›ã€æµ®åŠ›ã€é¢¨åŠ›ã€‚</li><li><strong>è¶…è·åŠ›</strong>ï¼š<span class="highlight">åœ°å¿ƒå¼•åŠ›ã€ç£åŠ›ã€éœé›»åŠ›</span>ã€‚</li></ul></div>`,
            'force2': `<div class="guide-content"><h3>1. å½ˆç°§ç§¤</h3><ul><li><strong>è™å…‹å®šå¾‹</strong>ï¼š<span class="highlight">æ›è¶Šé‡ï¼Œå½ˆç°§ä¼¸é•·è¶Šé•·</span>ï¼ˆæˆæ­£æ¯”ï¼‰ã€‚</li><li><strong>å–®ä½</strong>ï¼š<span class="highlight">å…¬å…‹é‡ (gw)</span>ã€‚</li></ul><h3>2. æ¸¬é‡</h3><ul><li>ä½¿ç”¨å‰è¦å…ˆ<span class="highlight">æ­¸é›¶</span>ã€‚</li></ul></div>`,
            'force3': `<div class="guide-content"><h3>1. æ‘©æ“¦åŠ›</h3><ul><li><strong>æ–¹å‘</strong>ï¼šè·Ÿç‰©é«”é‹å‹•æ–¹å‘<span class="highlight">ç›¸å</span>ã€‚</li></ul><h3>2. å½±éŸ¿å› ç´ </h3><ul><li><strong>æ¥è§¸é¢</strong>ï¼šè¶Š<span class="highlight">ç²—ç³™</span>ï¼Œæ‘©æ“¦åŠ›è¶Šå¤§ã€‚</li><li><strong>é‡é‡</strong>ï¼šç‰©é«”<span class="highlight">è¶Šé‡</span>ï¼Œæ‘©æ“¦åŠ›è¶Šå¤§ã€‚</li><li>è·Ÿæ¥è§¸é¢ç©å¤§å°<strong>ç„¡é—œ</strong>ï¼</li></ul></div>`,
            'economy1': `<div class="guide-content"><h3>1. åœŸåœ°æ”¹é©</h3><p>ä¸‰ä¸ƒäº”æ¸›ç§Ÿ â†’ å…¬åœ°æ”¾é ˜ â†’ è€•è€…æœ‰å…¶ç”°ã€‚</p><h3>2. å·¥æ¥­èµ·é£›</h3><ul><li><strong>è¼•å·¥æ¥­</strong>ï¼šç´¡ç¹”ã€é£Ÿå“ã€‚</li><li><strong>åŠ å·¥å‡ºå£å€</strong>ï¼š<span class="highlight">é«˜é›„ã€æ¥ æ¢“ã€è‡ºä¸­</span>ã€‚å¸å¼•å¤–è³‡ï¼Œå¢åŠ å°±æ¥­ã€‚</li></ul></div>`,
            'economy2': `<div class="guide-content"><h3>1. åå¤§å»ºè¨­</h3><p>ç™¼å±•é‡å·¥æ¥­ï¼ˆé‹¼éµã€é€ èˆ¹ï¼‰ã€‚äº¤é€šå»ºè¨­ï¼šé«˜é€Ÿå…¬è·¯ã€éµè·¯é›»æ°£åŒ–ã€‚</p><h3>2. ç§‘æŠ€å³¶å¶¼</h3><ul><li><strong>ç§‘å­¸åœ’å€</strong>ï¼š<span class="highlight">æ–°ç«¹</span>(ç«¹ç§‘)ã€‚</li><li><strong>ç”¢æ¥­å‡ç´š</strong>ï¼šå¾ä»£å·¥(OEM)è½‰å‘ç ”ç™¼ã€‚</li></ul></div>`,
            'society1': `<div class="guide-content"><h3>1. ç”Ÿæ´»åœˆ</h3><p>æ»¿è¶³å°±æ¥­ã€å°±å­¸ã€è³¼ç‰©éœ€æ±‚çš„ç¯„åœã€‚</p><h3>2. ä¸€æ—¥ç”Ÿæ´»åœˆ</h3><p>å› ç‚º<span class="highlight">é«˜éµã€æ·é‹</span>é€šè»Šï¼Œäº¤é€šè®Šå¿«äº†ã€‚</p></div>`,
            'society2': `<div class="guide-content"><h3>1. éƒ½å¸‚åŒ–</h3><p>äººå£å¾€éƒ½å¸‚é›†ä¸­ã€‚ç”¢ç”Ÿæˆ¿åƒ¹é«˜ã€å¡è»Šã€æ±™æŸ“ç­‰å•é¡Œã€‚</p><h3>2. é·ç§»åŸå› </h3><ul><li><strong>æ‹‰åŠ›</strong>ï¼ˆéƒ½å¸‚å¥½ï¼‰ï¼šå·¥ä½œå¤šã€ä¾¿åˆ©ã€‚</li><li><strong>æ¨åŠ›</strong>ï¼ˆé„‰æ‘å·®ï¼‰ï¼šå·¥ä½œå°‘ã€‚</li></ul></div>`,
            'society3': `<div class="guide-content"><h3>1. äººå£å•é¡Œ</h3><p>å°‘å­åŒ–ã€é«˜é½¡åŒ–ã€‚</p><h3>2. æ°¸çºŒç™¼å±•</h3><p><span class="highlight">åœ°æ–¹å‰µç”Ÿ</span>ï¼ˆæ•‘é„‰æ‘ï¼‰ã€ç¶ å»ºç¯‰ã€‚</p></div>`,
            'history1': `<div class="guide-content"><h3>1. èˆŠçŸ³å™¨ (é•·æ¿±)</h3><p>æ‰“è£½çŸ³å™¨ã€ç”¨ç«ã€‚</p><h3>2. æ–°çŸ³å™¨ (å¤§åŒå‘/å‘å—)</h3><p>ç£¨è£½çŸ³å™¨ã€é™¶å™¨ã€å®šå±…è¾²è€•ã€çŸ³æ¿æ£ºã€‚</p><h3>3. é‡‘å±¬å™¨ (åä¸‰è¡Œ)</h3><p>ç…‰éµã€äº¤æ˜“(ç»ç’ƒç )ã€‚</p></div>`,
            'history2': `<div class="guide-content"><h3>1. åŸä½æ°‘æ—</h3><ul><li><strong>å¹³åŸ”</strong>ï¼šæ¼¢åŒ–è¼ƒæ—©ã€‚</li><li><strong>é«˜å±±</strong>ï¼š16æ—ã€‚</li></ul><h3>2. æ–‡åŒ–</h3><p>é˜¿ç¾è±å¹´ç¥­ã€è³½å¤çŸ®éˆç¥­ã€ç™¾æ­¥è›‡å‚³èªª(æ’ç£/é­¯å‡±)ã€‚</p></div>`,
            'history3': `<div class="guide-content"><h3>1. è·è˜­ (å—å°ç£)</h3><p>ç†±è˜­é®åŸ(å®‰å¹³å¤å ¡)ã€è²¿æ˜“ã€æ–°æ¸¯æ–‡æ›¸(å‚³æ•™)ã€é»ƒç‰›ã€‚</p><h3>2. è¥¿ç­ç‰™ (åŒ—å°ç£)</h3><p>è–è–©çˆ¾ç“¦å¤šåŸ(åŸºéš†)ã€ç´…æ¯›åŸ(æ·¡æ°´)ã€‚</p></div>`,
            'history4': `<div class="guide-content"><h3>1. é„­æˆåŠŸ</h3><p>åæ¸…å¾©æ˜ã€è¶•èµ°è·è˜­äººã€‚</p><h3>2. å»ºè¨­</h3><p>é™³æ°¸è¯å»º<strong>å­”å»Ÿ</strong>(å…¨è‡ºé¦–å­¸)ã€‚è»éšŠ<strong>å±¯ç”°</strong>(å·¦ç‡Ÿã€æ–°ç‡Ÿ)ã€‚</p></div>`,
            'history5': `<div class="guide-content"><h3>1. æ¸…é ˜åˆæœŸ</h3><p>æ–½ç…æ”»å°ã€‚<strong>æ¸¡å°ç¦ä»¤</strong>(ç¦æ”œçœ·)å°è‡´<strong>ç¾…æ¼¢è…³</strong>(å–®èº«ç”·)å¤šã€‚</p><h3>2. æ°´åˆ©</h3><p>ç‘ å…¬åœ³(å°åŒ—)ã€å…«å ¡åœ³(å½°åŒ–)ã€æ›¹å…¬åœ³(é«˜é›„)ã€‚</p></div>`
        };

        // --- GAME DATA (æ“´å……é¡Œåº«æ¶æ§‹) ---
        // æœ¬åœ°é¡Œç›®å·²æ¸…ç©ºï¼Œå°‡ç”± fetchExtendedQuestions å¾é›²ç«¯è®€å–
        const GAME_DATA = {
            worlds: [
                {
                    id: 'world1',
                    title: 'ç¬¬ä¸€ä¸–ç•Œï¼šåœ°è³ªèˆ‡ç£å ´ (6ä¸Šè‡ªç„¶)',
                    bg: 'from-slate-900 via-slate-800 to-black',
                    zones: [
                        { id: 'river', name: 'èœ¿èœ’æºªæµ', icon: 'droplet', color: 'text-blue-500', mapPos: { top: '80%', left: '10%' }, enemies: [{ name: 'ä¸Šæ¸¸å·¨çŸ³æ€ª', hp: 225, dialogue: 'æˆ‘çš„é¡Œåº«æ·±ä¸è¦‹åº•ï¼', questions: [] }] },
                        { id: 'coast', name: 'ç‹‚é¢¨æµ·å²¸', icon: 'map', color: 'text-cyan-500', mapPos: { top: '65%', left: '20%' }, enemies: [{ name: 'æµ·è•å¹½éˆ', hp: 225, dialogue: 'ä½ èƒ½æŠµæ“‹æµ·æµªçš„æ”»å‹¢å—ï¼Ÿ', questions: [] }] },
                        { id: 'rocks', name: 'ç¤¦ç‰©ç‹åœ‹', icon: 'hammer', color: 'text-gray-400', mapPos: { top: '50%', left: '30%' }, enemies: [{ name: 'å²©çŸ³å·¨äºº', hp: 225, dialogue: 'ç¡¬ç¢°ç¡¬ï¼Œä½ è´ä¸äº†ï¼', questions: [] }] },
                        { id: 'disaster', name: 'éœ‡å‹•å±±è„ˆ', icon: 'alert-triangle', color: 'text-red-500', mapPos: { top: '35%', left: '40%' }, enemies: [{ name: 'éœ‡æ³¢é¾', hp: 225, dialogue: 'éœ‡åº¦7ç´šçš„è¡æ“Šï¼', questions: [] }] },
                        { id: 'magnet1', name: 'è¿·éœ§ç£æ—', icon: 'compass', color: 'text-purple-400', mapPos: { top: '35%', left: '60%' }, enemies: [{ name: 'åœ°ç£å®ˆè­·è€…', hp: 225, dialogue: 'æŒ‡å—é‡æœƒå‘Šè¨´ä½ çœŸç›¸ï¼', questions: [] }] },
                        { id: 'magnet2', name: 'é›·é›»éºè·¡', icon: 'zap', color: 'text-yellow-400', mapPos: { top: '55%', left: '70%' }, enemies: [{ name: 'ç·šåœˆé­”åƒ', hp: 225, dialogue: 'é›»æµå¢å¼·ï¼Œç£åŠ›å¢å¼·ï¼', questions: [] }] },
                        { id: 'magnet3', name: 'ç£æµ®æœªä¾†åŸ', icon: 'cpu', color: 'text-pink-400', mapPos: { top: '80%', left: '80%' }, enemies: [{ name: 'æ©Ÿç”²åšå£«', hp: 225, dialogue: 'é¦¬é”å…¨é€Ÿé‹è½‰ï¼', questions: [] }] },
                        { id: 'boss1', name: 'é­”ç‹é—œï¼šåœ°å¿ƒè©¦ç…‰', icon: 'skull', color: 'text-purple-600', mapPos: { top: '55%', left: '50%' }, enemies: [{ name: 'ç£åŠ›é¾ç‹', hp: 500, dialogue: 'å¾ä¹ƒåœ°å¿ƒä¹‹ä¸»ï¼Œæ¥å—æœ€çµ‚è©¦ç…‰å§ï¼', questions: [] }] }
                    ]
                },
                // --- ç¬¬äºŒä¸–ç•Œ (5ä¸Šè‡ªç„¶) ---
                {
                    id: 'world2',
                    title: 'ç¬¬äºŒä¸–ç•Œï¼šæ°´éŠé‡‘èˆ‡åŠ›å ´ (5ä¸Šè‡ªç„¶)',
                    bg: 'from-indigo-900 via-purple-900 to-black',
                    zones: [
                        { id: 'solution1', name: 'ç¥ç§˜æº¶æ´', icon: 'flask-conical', color: 'text-blue-300', mapPos: { top: '80%', left: '20%' }, enemies: [{ name: 'çµæ™¶å²èŠå§†', hp: 225, dialogue: 'é£½å’Œ...æå‡º...', questions: [] }] },
                        { id: 'solution2', name: 'é…¸é¹¼å¯¦é©—å®¤', icon: 'test-tube', color: 'text-green-400', mapPos: { top: '60%', left: '30%' }, enemies: [{ name: 'çŸ³è•Šè©¦åŠ‘æ€ª', hp: 225, dialogue: 'è®Šç´…é‚„æ˜¯è®Šè—ï¼Ÿ', questions: [] }] },
                        { id: 'solution3', name: 'å°é›»å…‰å»Š', icon: 'lightbulb', color: 'text-yellow-300', mapPos: { top: '40%', left: '40%' }, enemies: [{ name: 'é›»è§£è³ªå¹½éˆ', hp: 225, dialogue: 'é›»æµé€šéä¸­ï¼', questions: [] }] },
                        { id: 'force1', name: 'é‡åŠ›è’é‡', icon: 'arrow-down', color: 'text-orange-500', mapPos: { top: '30%', left: '60%' }, enemies: [{ name: 'å¼•åŠ›å·¨ç¸', hp: 225, dialogue: 'è¬æœ‰å¼•åŠ›ï¼', questions: [] }] },
                        { id: 'force2', name: 'æ¸¬é‡é«˜å¡”', icon: 'scale', color: 'text-teal-400', mapPos: { top: '50%', left: '75%' }, enemies: [{ name: 'ç²¾æº–æ©Ÿé—œäºº', hp: 225, dialogue: '1å…‹éƒ½ä¸èƒ½å·®ï¼', questions: [] }] },
                        { id: 'force3', name: 'æ‘©æ“¦å³½è°·', icon: 'move', color: 'text-rose-500', mapPos: { top: '80%', left: '85%' }, enemies: [{ name: 'é˜»åŠ›å²©æ€ª', hp: 225, dialogue: 'å¯¸æ­¥é›£è¡Œï¼', questions: [] }] },
                        { id: 'boss2', name: 'é­”ç‹é—œï¼šçœŸç†è–æ®¿', icon: 'skull', color: 'text-purple-600', mapPos: { top: '50%', left: '50%' }, enemies: [{ name: 'çœŸç†è³¢è€…', hp: 500, dialogue: 'æ°´èˆ‡åŠ›çš„å¥§ç¾©ï¼Œä½ çœŸçš„åƒé€äº†å—ï¼Ÿ', questions: [] }] }
                    ]
                },
                // --- ç¬¬ä¸‰ä¸–ç•Œ (6ä¸Šç¤¾æœƒ) ---
                {
                    id: 'world3',
                    title: 'ç¬¬ä¸‰ä¸–ç•Œï¼šç¤¾æœƒèˆ‡è®Šé· (6ä¸Šç¤¾æœƒ)',
                    bg: 'from-amber-900 via-stone-800 to-black',
                    zones: [
                        { id: 'economy1', name: 'èµ·é£›å¹³åŸ', icon: 'wheat', color: 'text-amber-500', mapPos: { top: '80%', left: '15%' }, enemies: [{ name: 'åœŸåœ°æ”¹é©è€…', hp: 225, dialogue: 'è€•è€…æœ‰å…¶ç”°ï¼', questions: [] }] },
                        { id: 'economy2', name: 'çŸ½æ™¶å±±è°·', icon: 'microchip', color: 'text-teal-500', mapPos: { top: '55%', left: '30%' }, enemies: [{ name: 'æ™¶åœ“æ©Ÿå™¨äºº', hp: 225, dialogue: 'ç”¢æ¥­æ­£åœ¨å‡ç´šä¸­...', questions: [] }] },
                        { id: 'society1', name: 'ç”Ÿæ´»åœˆè¿·å®®', icon: 'train-front', color: 'text-blue-500', mapPos: { top: '30%', left: '50%' }, enemies: [{ name: 'æ·é‹é€Ÿé¾', hp: 225, dialogue: 'ä¸€æ—¥ç”Ÿæ´»åœˆï¼', questions: [] }] },
                        { id: 'society2', name: 'æ“æ“ éƒ½æœƒ', icon: 'building-2', color: 'text-gray-400', mapPos: { top: '45%', left: '75%' }, enemies: [{ name: 'å¡è»Šæ€ªç¸', hp: 225, dialogue: 'å­å­å­ï¼', questions: [] }] },
                        { id: 'society3', name: 'æ°¸çºŒæ–¹èˆŸ', icon: 'leaf', color: 'text-green-500', mapPos: { top: '80%', left: '85%' }, enemies: [{ name: 'æ™‚å…‰å®ˆè­·è€…', hp: 225, dialogue: 'ç‚ºäº†ä¸‹ä¸€ä»£ï¼', questions: [] }] },
                        { id: 'boss3', name: 'é­”ç‹é—œï¼šç¶“å»ºç¸½ç½²', icon: 'skull', color: 'text-purple-600', mapPos: { top: '50%', left: '50%' }, enemies: [{ name: 'ç™¼å±•éƒ¨é•·', hp: 500, dialogue: 'ç¤¾æœƒçš„è®Šé·ï¼Œä½ è·Ÿä¸Šäº†å—ï¼Ÿ', questions: [] }] }
                    ]
                },
                // --- ç¬¬å››ä¸–ç•Œ (5ä¸Šç¤¾æœƒ) ---
                {
                    id: 'world4',
                    title: 'ç¬¬å››ä¸–ç•Œï¼šæ­·å²èˆ‡æ–‡åŒ– (5ä¸Šç¤¾æœƒ)',
                    bg: 'from-amber-900 via-blue-900 to-black',
                    zones: [
                        { id: 'history1', name: 'å²å‰éºè·¡', icon: 'fossil', color: 'text-amber-600', mapPos: { top: '80%', left: '15%' }, enemies: [{ name: 'çŸ³å™¨å…ˆç¥–', hp: 225, dialogue: 'å—šå˜å˜ï¼(åŸå§‹äººèª)', questions: [] }] },
                        { id: 'history2', name: 'éƒ¨è½å‚³èªª', icon: 'feather', color: 'text-emerald-500', mapPos: { top: '55%', left: '25%' }, enemies: [{ name: 'ç™¾æ­¥è›‡ç¥', hp: 225, dialogue: 'ç¥–éˆåœ¨çœ‹è‘—ä½ ã€‚', questions: [] }] },
                        { id: 'history3', name: 'èˆªæµ·æ™‚ä»£', icon: 'ship', color: 'text-sky-500', mapPos: { top: '30%', left: '50%' }, enemies: [{ name: 'è·è˜­èˆ¹é•·', hp: 225, dialogue: 'è¦è²·é¹¿çš®å—ï¼Ÿ', questions: [] }] },
                        { id: 'history4', name: 'æ˜é„­ç‹æœ', icon: 'crown', color: 'text-red-600', mapPos: { top: '45%', left: '75%' }, enemies: [{ name: 'å»¶å¹³éƒ¡ç‹', hp: 225, dialogue: 'é©…é€ç´…æ¯›ç•ªï¼', questions: [] }] },
                        { id: 'history5', name: 'æ–‡åŒ–äº¤è', icon: 'scroll', color: 'text-indigo-500', mapPos: { top: '80%', left: '85%' }, enemies: [{ name: 'æ¸¡å°ç§»æ°‘', hp: 225, dialogue: 'å”å±±éå°ç£ï¼Œå¿ƒè‚çµæ­¸ä¸¸...', questions: [] }] },
                        { id: 'boss4', name: 'é­”ç‹é—œï¼šæ­·å²è¿´å»Š', icon: 'skull', color: 'text-purple-600', mapPos: { top: '50%', left: '50%' }, enemies: [{ name: 'æ™‚å…‰å®ˆè­·ç¥', hp: 500, dialogue: 'æ­·å²çš„æ´ªæµï¼Œä½ èƒ½è¨˜ä½å¤šå°‘ï¼Ÿ', questions: [] }] }
                    ]
                }
            ]
        };

        // --- STATE ---
        let gameState = 'START'; 
        let currentWorldIndex = 0;
        let player = { name: '', role: '', hp: 100, maxHp: 100, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: null, stats: {}, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
        let currentZone = null, currentEnemy = null, currentQuestion = null;
        let battleLog = [], enemyIndex = 0, showZoneInfo = null, questionCountInBattle = 0;
        let showCheerMessage = false;
        let leaderboardData = [];
        let showLeaderboard = false;
        let activeLeaderboardTab = 0;
        let showGameIntro = false;
        let cheatCodeBuffer = "";
        let isQuestionsLoaded = false; 
        let showDebugButton = false; 
        let isBattleAnimating = false; 
        let floatingEffects = []; 
        let activeAnimations = { player: '', enemy: '' }; // æ–°å¢ï¼šå‹•ç•«ç‹€æ…‹
        
        let battleStats = { startTime: 0, correct: 0, attempts: 0, score: 0 };

        // --- HELPERS ---
        function addLog(text) { battleLog.push(text); if (battleLog.length > 4) battleLog.shift(); renderApp(); }
        
        function unlockZone(zoneId) {
            if (player.characterId === 'book_immortal') return true;
            const world = GAME_DATA.worlds[currentWorldIndex];
            
            if (zoneId.startsWith('boss')) {
                const normalZones = world.zones.filter(z => !z.id.startsWith('boss'));
                return normalZones.every(z => player.completedZones.includes(z.id));
            }
            
            return true;
        }

        function getUnsolvedQuestion(enemy) {
            const available = enemy.questions.filter(q => !player.solvedQuestionIds.includes(q.id));
            if (available.length === 0) return null;
            return available[Math.floor(Math.random() * available.length)];
        }

        function prepareQuestion(q) {
            let indices = q.options.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            return { ...q, shuffledOptions: indices.map(i => q.options[i]), correctIndex: indices.indexOf(q.a) };
        }
        
        // --- FETCH EXTENDED QUESTIONS ---
        async function diagnoseConnection() {
            if (!GAS_API_URL) {
                showModal({title: "è¨­å®šéŒ¯èª¤", message: "è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š GAS_API_URLï¼", showCancel: false});
                return;
            }
            
            showToast("æ­£åœ¨è¨ºæ–·é€£ç·š...");
            try {
                const start = Date.now();
                const res = await fetch(GAS_API_URL + "?op=questions&t=" + start);
                const text = await res.text(); 
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error("API å›å‚³çš„ä¸æ˜¯ JSONã€‚å¯èƒ½æ˜¯æ¬Šé™ä¸è¶³ (éœ€è¦è¨­ç‚ºæ‰€æœ‰äºº)ï¼Œæˆ– Apps Script ç™¼ç”ŸéŒ¯èª¤ã€‚\nå›å‚³å…§å®¹å‰ 100 å­—:\n" + text.substring(0, 100));
                }

                if (data.error) {
                    throw new Error("GAS å…§éƒ¨éŒ¯èª¤: " + data.message);
                }

                let stats = "";
                let total = 0;
                Object.keys(data).forEach(zoneId => {
                    stats += `${zoneId}: ${data[zoneId].length} é¡Œ\n`;
                    total += data[zoneId].length;
                });

                if (total === 0) {
                    showModal({
                        title: "é€£ç·šæˆåŠŸä½†ç„¡é¡Œç›®", 
                        message: "æˆåŠŸé€£ç·šåˆ° GASï¼Œä½†æ²’æœ‰è®€å–åˆ°ä»»ä½•é¡Œç›®ã€‚\nè«‹æª¢æŸ¥ï¼š\n1. Google è©¦ç®—è¡¨æ˜¯å¦æœ‰ 'world1' ç­‰å·¥ä½œè¡¨ï¼Ÿ\n2. å·¥ä½œè¡¨åç¨±æ˜¯å¦åŒ…å« 'world' (ä¸åˆ†å¤§å°å¯«)ï¼Ÿ\n3. å…§å®¹æ˜¯å¦æœ‰å¾ A2 é–‹å§‹å¡«å¯«ï¼Ÿ",
                        showCancel: false
                    });
                } else {
                    showModal({
                        title: "é€£ç·šè¨ºæ–·æˆåŠŸ", 
                        message: `æˆåŠŸè®€å–åˆ° ${total} é¡Œï¼\n\nè©³ç´°åˆ†ä½ˆï¼š\n${stats}\n\nå¦‚æœä¸è¦‹é¡Œç›®ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚`,
                        showCancel: false
                    });
                    processQuestionData(data);
                }

            } catch (e) {
                showModal({
                    title: "é€£ç·šå¤±æ•—", 
                    message: "ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message + "\n\nå¸¸è¦‹åŸå› ï¼š\n1. GAS éƒ¨ç½²æ™‚ã€Œèª°å¯ä»¥å­˜å–ã€æœªè¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚\n2. GAS ç¨‹å¼ç¢¼æœªæ›´æ–° (è«‹å»ºç«‹æ–°ç‰ˆéƒ¨ç½²)ã€‚",
                    showCancel: false
                });
            }
        }

        function processQuestionData(data) {
            let count = 0;
            GAME_DATA.worlds.forEach(w => {
                w.zones.forEach(z => {
                    if (data[z.id] && Array.isArray(data[z.id])) {
                        const enemy = z.enemies[0];
                        enemy.questions = [];
                        enemy.questions.push(...data[z.id]);
                        count += data[z.id].length;
                    }
                });
            });
            
            GAME_DATA.worlds.forEach(world => {
                const bossZone = world.zones.find(z => z.id.startsWith('boss'));
                if (bossZone) {
                    const bossEnemy = bossZone.enemies[0];
                    bossEnemy.questions = []; 
                    world.zones.forEach(z => {
                        if (z !== bossZone) {
                            z.enemies.forEach(e => {
                                bossEnemy.questions.push(...e.questions);
                            });
                        }
                    });
                }
            });
            
            if (count > 0) {
                isQuestionsLoaded = true;
                showToast(`å·²è¼‰å…¥ ${count} é¡Œï¼`);
            }
        }

        async function fetchExtendedQuestions() {
            if (!GAS_API_URL) return;
            try {
                const res = await fetch(GAS_API_URL + "?op=questions&t=" + new Date().getTime());
                const data = await res.json();
                processQuestionData(data);
            } catch (e) {
                console.warn("Auto-fetch failed, use debug button.", e);
            }
        }
        
        fetchExtendedQuestions();

        // --- CHEAT CODE LOGIC ---
        document.addEventListener('keydown', (e) => {
            if (e.key.length === 1) {
                cheatCodeBuffer += e.key;
                if (cheatCodeBuffer.length > 30) {
                    cheatCodeBuffer = cheatCodeBuffer.slice(-30);
                }
            }

            const targetMap = "2u/2u/xl3gw94gj94xk7";
            const targetDebug = "hk4g4xu06vu04";
            const bufferNormalized = cheatCodeBuffer.replace(/\s/g, '');
            
            if (gameState === 'MAP' && bufferNormalized.includes(targetMap)) {
                activateCheat();
                cheatCodeBuffer = ""; 
            }

            if (gameState === 'START' && bufferNormalized.includes(targetDebug)) {
                showDebugButton = true;
                showToast("é™¤éŒ¯æ¨¡å¼å·²å•Ÿç”¨");
                renderApp();
                cheatCodeBuffer = "";
            }
        });

        function handleTitleClick() {
             if (gameState !== 'MAP') return;
             if (!window.titleClickCount) window.titleClickCount = 0;
             window.titleClickCount++;
             
             if (window.titleClickCount >= 5) {
                 window.titleClickCount = 0;
                 showModal({
                    title: 'å¯†æŠ€',
                    inputPlaceholder: 'è«‹è¼¸å…¥å¯†æŠ€æŒ‡ä»¤',
                    onConfirm: (code) => {
                        if (code && code.replace(/\s/g, '') === "2u/2u/xl3gw94gj94xk7") {
                            activateCheat();
                        }
                    }
                 });
             }
             
             if (window.titleClickTimer) clearTimeout(window.titleClickTimer);
             window.titleClickTimer = setTimeout(() => { window.titleClickCount = 0; }, 2000);
        }

        function activateCheat() {
            showToast("å¯†æŠ€å•Ÿå‹•ï¼šè€å¸«å¤ªå¸¥äº†ï¼å¾—åˆ† 9999ï¼");
            
            const currentWorld = GAME_DATA.worlds[currentWorldIndex];
            currentWorld.zones.forEach(z => {
                if (!player.completedZones.includes(z.id)) {
                    player.completedZones.push(z.id);
                }
            });
            
            player.level = 99;
            player.hp = 9999;
            player.maxHp = 9999;
            
            uploadCheatScore();
            
            renderApp();
        }

        function uploadCheatScore() {
            if (!GAS_API_URL) return;
            let defaultName = player.name;
            if (!defaultName || defaultName === CHARACTERS.find(c => c.id === player.characterId).name) {
                 defaultName = "ç¥ç¥•é«˜æ‰‹";
            }

            showModal({
                title: 'ç™»éŒ„è‹±é›„æ¦œ (å¯†æŠ€ç‰ˆ)',
                message: 'è«‹è¼¸å…¥æ‚¨çš„åå­—ï¼š',
                inputPlaceholder: defaultName,
                onConfirm: (userName) => {
                    if (!userName) userName = "ç¥ç¥•é«˜æ‰‹";
                    player.name = userName;

                    const payload = {
                        name: userName,
                        role: CHARACTERS.find(c => c.id === player.characterId).name,
                        world: GAME_DATA.worlds[currentWorldIndex].title,
                        level: 99,
                        score: 9999
                    };
                    
                    fetch(GAS_API_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    }).then(() => {
                        console.log("Cheat score uploaded.");
                        showToast("å¯†æŠ€æˆç¸¾å·²ç™»éŒ„ï¼");
                    });
                }
            });
        }

        // --- API ACTIONS ---
        function uploadScore() {
            if (!GAS_API_URL) {
                showToast("è«‹å…ˆè¨­å®š GAS_API_URLï¼");
                return;
            }
            
            const currentPlayerName = player.name;
            const defaultCharName = CHARACTERS.find(c => c.id === player.characterId).name;
            const inputValue = (currentPlayerName && currentPlayerName !== defaultCharName) ? currentPlayerName : '';
            const currentWorldScore = player.worldScores[currentWorldIndex] || 0;

            showModal({
                title: 'ä¸Šå‚³æˆ°ç¸¾',
                message: `ä¸Šå‚³ç›®å‰ä¸–ç•Œç¸½ç©åˆ†: ${currentWorldScore}\nè«‹è¼¸å…¥æ‚¨çš„åå­—ä»¥ä¾¿ç™»éŒ„è‹±é›„æ¦œï¼š`,
                inputPlaceholder: 'è«‹è¼¸å…¥åå­— (å¦‚: 601 ç‹å°æ˜)',
                inputValue: inputValue,
                onConfirm: (userName) => {
                    if (!userName) return;
                    player.name = userName;

                    const payload = {
                        name: userName,
                        role: CHARACTERS.find(c => c.id === player.characterId).name,
                        world: GAME_DATA.worlds[currentWorldIndex].title,
                        level: player.level,
                        score: currentWorldScore 
                    };

                    addLog("æ­£åœ¨ä¸Šå‚³æˆ°ç¸¾...");
                    
                    fetch(GAS_API_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(() => {
                        addLog("æˆ°ç¸¾ä¸Šå‚³æˆåŠŸï¼");
                        showToast("æˆ°ç¸¾ä¸Šå‚³æˆåŠŸï¼");
                        if (!player.uploadedZones.includes(currentZone.id)) {
                            player.uploadedZones.push(currentZone.id);
                        }
                        renderApp();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        addLog("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                        showToast("ä¸Šå‚³å¤±æ•—ï¼");
                    });
                }
            });
        }

        function fetchLeaderboard() {
            if (!GAS_API_URL) {
                leaderboardData = [
                    { name: "æ¸¬è©¦ç©å®¶1", role: "é­”æ³•å¸«ç§‘è²´", world: "ç¬¬ä¸€ä¸–ç•Œ", level: 5, score: 20 },
                    { name: "æ¸¬è©¦ç©å®¶2", role: "å¥³æˆ°å£«å¦˜è", world: "ç¬¬ä¸€ä¸–ç•Œ", level: 3, score: 15 }
                ];
                renderApp();
                return;
            }

            fetch(GAS_API_URL)
            .then(response => response.json())
            .then(data => {
                leaderboardData = data;
                renderApp();
            })
            .catch(error => {
                console.error("Error fetching leaderboard:", error);
                leaderboardData = []; 
                renderApp();
            });
        }

        function toggleLeaderboard() {
            showLeaderboard = !showLeaderboard;
            if (showLeaderboard) {
                fetchLeaderboard();
            }
            renderApp();
        }

        function switchLeaderboardTab(index) {
            activeLeaderboardTab = index;
            renderApp();
        }
        
        function toggleGameIntro() {
            showGameIntro = !showGameIntro;
            renderApp();
        }

        // --- ACTIONS ---
        function switchWorld(index) {
            currentWorldIndex = index;
            showZoneInfo = null;
            renderApp();
        }

        function toCharSelect() { gameState = 'CHAR_SELECT'; renderApp(); }
        
        function returnToMainMenu() { 
            gameState = 'START';
            player = { name: '', role: '', hp: 100, maxHp: 100, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: null, stats: {}, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
            battleLog = [];
            currentWorldIndex = 0;
            renderApp();
        }

        function forgetClothes() {
            gameState = 'START';
            player = { name: '', role: '', hp: 100, maxHp: 100, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: null, stats: {}, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
            battleLog = [];
            currentWorldIndex = 0;
            showCheerMessage = true;
            renderApp();
            setTimeout(() => {
                showCheerMessage = false;
                renderApp();
            }, 3000);
        }

        function selectCharacter(charId) {
            const char = CHARACTERS.find(c => c.id === charId);
            player = { name: char.name, role: char.role, hp: char.stats.hp, maxHp: char.stats.hp, level: 1, xp: 0, maxXp: 50, items: [], completedZones: [], uploadedZones: [], characterId: char.id, stats: char.stats, solvedQuestionIds: [], worldScores: [0, 0, 0, 0] };
            gameState = 'MAP';
            battleLog = char.id === 'book_immortal' ? ['æ­¡è¿æ›¸ä»™ï¼', 'æ”»ç•¥æ¨¡å¼é–‹å•Ÿã€‚'] : [`æ­¡è¿ ${char.name}ï¼`, `èƒ½åŠ›ï¼š${char.abilityName}`];
            if(char.id === 'book_immortal') {
                GAME_DATA.worlds.forEach(w => w.zones.forEach(z => player.completedZones.push(z.id)));
            }
            renderApp();
        }

        function enterZone(zoneId) {
            const world = GAME_DATA.worlds[currentWorldIndex];
            const zone = world.zones.find(z => z.id === zoneId);
            
            if (player.characterId !== 'book_immortal' && !zone.id.startsWith('boss')) {
                if (zone.enemies[0].questions.length === 0) {
                    showModal({
                        title: "é¡Œåº«æœªå°±ç·’", 
                        message: "å°šæœªå¾é›²ç«¯è®€å–åˆ°é¡Œç›®ï¼Œè«‹å…ˆæŒ‰å³ä¸‹è§’çš„ã€Œæ¸¬è©¦é€£ç·šã€æª¢æŸ¥ã€‚", 
                        showCancel: false
                    });
                    return;
                }
            }

            if (!unlockZone(zone.id)) return;
            currentZone = zone;
            showZoneInfo = null;
            if (player.characterId === 'book_immortal') { gameState = 'GUIDE'; renderApp(); } 
            else { enemyIndex = 0; startBattle(zone.enemies[0]); }
        }

        function startBattle(enemy) {
            battleStats = { startTime: Date.now(), correct: 0, attempts: 0, score: 0 };
            const allQuestions = enemy.questions;
            
            let pool = [];
            if (currentZone.id.startsWith('boss')) {
                 pool = allQuestions.filter(q => !player.solvedQuestionIds.includes(q.id));
                 if (pool.length === 0) {
                     battleLog.push(`ğŸ‰ ${enemy.name} è©¦ç…‰å®Œæˆï¼`); 
                     handleEnemyDefeat(enemy); 
                     return; 
                 }
            } else {
                 pool = [...allQuestions];
            }

            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }

            const battleQuestions = pool.slice(0, 15);
            enemy.battleQuestions = battleQuestions;
            enemy.battleIndex = 0;
            currentEnemy = { ...enemy, currentHp: 225 }; 
            
            if (battleQuestions.length > 0) {
                currentQuestion = prepareQuestion(battleQuestions[0]);
                gameState = 'BATTLE';
                battleLog.push(`é­é‡ï¼š${enemy.name}ï¼`);
            } else {
                handleEnemyDefeat(enemy);
            }
            renderApp();
        }

        function handleAnswer(idx) {
            if (isBattleAnimating) return; 
            if (!currentQuestion) return;
            
            isBattleAnimating = true;
            const isCorrect = idx === currentQuestion.correctIndex;
            
            const attacker = isCorrect ? 'player' : 'enemy';
            const victim = isCorrect ? 'enemy' : 'player';
            
            activeAnimations.player = attacker === 'player' ? 'anim-attack-p' : '';
            activeAnimations.enemy = attacker === 'enemy' ? 'anim-attack-e' : '';
            renderApp();

            let dmg = 0;
            let heal = 0;
            
            if (isCorrect) {
                dmg = 15 + (player.stats.dmgBonus || 0);
                heal = player.stats.healOnHit || 0;
            } else {
                dmg = Math.max(1, 15 - player.stats.dmgReduction);
            }

            setTimeout(() => {
                activeAnimations.player = '';
                activeAnimations.enemy = '';
                activeAnimations[victim] = 'anim-damage';

                const text = `-${dmg}`;
                const x = isCorrect ? 75 : 25; 
                
                floatingEffects.push({ id: Date.now(), text: text, type: 'text-red-500', x: x, y: 40 });
                if (isCorrect && heal > 0) {
                    floatingEffects.push({ id: Date.now()+1, text: `+${heal}`, type: 'text-green-500', x: 25, y: 30 });
                }
                
                renderApp();

            }, 300);

            setTimeout(() => {
                activeAnimations.player = '';
                activeAnimations.enemy = '';
                battleStats.attempts++;

                if (isCorrect) {
                    battleStats.correct++;
                    currentEnemy.currentHp -= dmg;
                    addLog(`âœ… æ­£ç¢ºï¼å‚·å®³ ${dmg}ï¼`);
                    
                    if(!player.solvedQuestionIds.includes(currentQuestion.id)) player.solvedQuestionIds.push(currentQuestion.id);
                    
                    if (heal > 0) {
                        player.hp = Math.min(player.maxHp, player.hp + heal);
                    }
                    
                    const xpGain = Math.floor(15 * player.stats.xpBonus);
                    player.xp += xpGain;
                    if (player.xp >= player.maxXp) { 
                        player.xp -= player.maxXp; 
                        player.level++; 
                        player.maxXp = Math.floor(player.maxXp*1.5); 
                        player.hp = player.maxHp; 
                        addLog('ğŸ‰ å‡ç´šï¼'); 
                    }
                    
                    currentEnemy.battleIndex++;
                    if (currentEnemy.currentHp <= 0 || currentEnemy.battleIndex >= currentEnemy.battleQuestions.length) {
                        handleEnemyDefeat(currentEnemy);
                    } else {
                        const nextQ = currentEnemy.battleQuestions[currentEnemy.battleIndex];
                        currentQuestion = prepareQuestion(nextQ);
                    }
                } else {
                    player.hp -= dmg;
                    addLog(`âŒ éŒ¯èª¤ï¼å—å‚· ${dmg}`);
                    addLog(`æ­£è§£ï¼š${currentQuestion.options[currentQuestion.a]}`);
                    if (player.hp <= 0) {
                         gameState = 'GAMEOVER';
                    }
                }
                
                isBattleAnimating = false;
                floatingEffects = []; 
                renderApp();
            }, 800);
        }

        function handleEnemyDefeat(enemy) {
            const endTime = Date.now();
            const durationSec = Math.floor((endTime - battleStats.startTime) / 1000);
            const accuracy = battleStats.attempts > 0 ? (battleStats.correct / battleStats.attempts) : 0;
            const timeBonus = Math.max(0, (300 - durationSec) * 10); 
            const baseScore = battleStats.correct * 1000;
            
            const levelScore = Math.floor(baseScore * Math.pow(accuracy, 2) + timeBonus);
            
            if (!player.worldScores[currentWorldIndex]) {
                 player.worldScores[currentWorldIndex] = 0;
            }
            player.worldScores[currentWorldIndex] += levelScore;

            battleStats.score = levelScore;
            battleStats.duration = durationSec;
            battleStats.accuracy = (accuracy * 100).toFixed(1);

            addLog(`ğŸ† æ“Šæ•— ${enemy.name}ï¼`);
            if (!player.completedZones.includes(currentZone.id)) player.completedZones.push(currentZone.id);
            gameState = 'VICTORY';
            renderApp();
        }

        function showZonePopup(zoneId) { if(unlockZone(zoneId)) { showZoneInfo = GAME_DATA.worlds[currentWorldIndex].zones.find(z => z.id === zoneId); renderApp(); } }
        function closeZonePopup() { showZoneInfo = null; renderApp(); }
        function returnToMap() { gameState = 'MAP'; showZoneInfo = null; renderApp(); }
        function restartGame() { gameState = 'START'; renderApp(); }

        // --- RENDER ---
        function renderApp() {
            const app = document.getElementById('app');
            let content = '';
            
            if (showCheerMessage) {
                content += `
                <div class="fixed top-0 left-0 w-full h-full flex items-center justify-center z-50 bg-black/80 pointer-events-none animate-fade-in">
                    <div class="bg-amber-600 text-white px-8 py-4 rounded-xl text-2xl font-bold shadow-2xl transform scale-110">
                        åŠ æ²¹å¥½å—?
                    </div>
                </div>`;
            }

            if (gameState !== 'START' && gameState !== 'CHAR_SELECT') {
                content += `
                <header class="bg-slate-900 border-b border-slate-800 p-2 flex justify-between items-center z-20 shadow-lg">
                    <div class="flex gap-2 items-center">
                        <span class="font-bold text-amber-100 cursor-pointer select-none active:scale-95 transition-transform" onclick="handleTitleClick()">è¥¿å¯§æ¢éšªå®¶</span>
                        ${gameState === 'MAP' ? `
                        <div class="flex bg-slate-800 rounded p-1">
                            <button onclick="switchWorld(0)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===0 ? 'bg-amber-600 text-white' : 'text-slate-400'}">W1</button>
                            <button onclick="switchWorld(1)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===1 ? 'bg-indigo-600 text-white' : 'text-slate-400'}">W2</button>
                            <button onclick="switchWorld(2)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===2 ? 'bg-teal-600 text-white' : 'text-slate-400'}">W3</button>
                            <button onclick="switchWorld(3)" class="px-2 py-1 text-xs rounded ${currentWorldIndex===3 ? 'bg-emerald-600 text-white' : 'text-slate-400'}">W4</button>
                        </div>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${player.role !== 'Guide' ? `<button onclick="toggleLeaderboard()" class="p-1.5 bg-yellow-600 hover:bg-yellow-500 rounded text-white shadow"><i data-lucide="trophy" class="w-4 h-4"></i></button>` : ''}
                        <div class="text-xs text-slate-300">Lv.${player.level}</div>
                        <button onclick="returnToMap()" class="px-2 py-1 bg-slate-700 text-xs rounded">åœ°åœ–</button>
                    </div>
                </header>`;
            }

            content += `<main class="flex-1 overflow-auto bg-gradient-to-b ${GAME_DATA.worlds[currentWorldIndex].bg} relative w-full h-full">`;
            
            if (gameState === 'START') content += renderStart();
            else if (gameState === 'CHAR_SELECT') content += renderCharSelect();
            else if (gameState === 'MAP') content += renderMap();
            else if (gameState === 'BATTLE') content += renderBattle();
            else if (gameState === 'VICTORY') content += renderVictory();
            else if (gameState === 'GAMEOVER') content += renderGameOver();
            else if (gameState === 'GUIDE') content += renderGuide();

            if (showGameIntro) {
                content += `
                <div class="absolute inset-0 z-50 bg-black/90 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-slate-900 border border-blue-500/50 w-full max-w-2xl h-3/4 rounded-xl flex flex-col shadow-2xl">
                        <div class="flex justify-between items-center p-4 border-b border-slate-700">
                            <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2"><i data-lucide="book-open"></i> éŠæˆ²ä»‹ç´¹</h2>
                            <button onclick="toggleGameIntro()" class="text-slate-400 hover:text-white">âœ•</button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 text-slate-300 space-y-4">
                            <h3 class="text-lg font-bold text-white">æ•…äº‹èƒŒæ™¯</h3>
                            <p>è¥¿å¯§åœ‹å°æ­£é¢è‡¨ä¸€å ´è·¨è¶Šæ™‚ç©ºçš„å±æ©Ÿï¼ä½ éœ€è¦é‹ç”¨è‡ªç„¶èˆ‡ç¤¾æœƒç§‘çš„çŸ¥è­˜ï¼Œé€šéå››å¤§ä¸–ç•Œçš„è©¦ç…‰ï¼Œè§£é–‹åœ°è³ªã€ç£å ´ã€æ°´åŠ›èˆ‡æ­·å²çš„è¬åœ˜ã€‚</p>
                            <h3 class="text-lg font-bold text-white">å››å¤§ä¸–ç•Œ</h3>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><span class="text-amber-400">ç¬¬ä¸€ä¸–ç•Œ</span>ï¼šæ¢ç´¢æ²³æµåœ°å½¢èˆ‡ç£éµå¥§ç¥• (6ä¸Šè‡ªç„¶)ã€‚</li>
                                <li><span class="text-indigo-400">ç¬¬äºŒä¸–ç•Œ</span>ï¼šæŒæ¡æ°´æº¶æ¶²æ€§è³ªèˆ‡åŠ›çš„ä½œç”¨ (5ä¸Šè‡ªç„¶)ã€‚</li>
                                <li><span class="text-teal-400">ç¬¬ä¸‰ä¸–ç•Œ</span>ï¼šè¦‹è­‰å°ç£ç¶“æ¿Ÿèµ·é£›èˆ‡ç¤¾æœƒè®Šé· (6ä¸Šç¤¾æœƒ)ã€‚</li>
                                <li><span class="text-emerald-400">ç¬¬å››ä¸–ç•Œ</span>ï¼šç©¿è¶Šå²å‰èˆ‡å¤§èˆªæµ·æ™‚ä»£çš„æ­·å² (5ä¸Šç¤¾æœƒ)ã€‚</li>
                            </ul>
                            <h3 class="text-lg font-bold text-white">è§’è‰²ä»‹ç´¹</h3>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>ç§‘è²´</strong>ï¼šç¶“é©—å€¼åŠ æˆï¼Œå‡ç´šå¿«ã€‚</li>
                                <li><strong>å´‡äº¦</strong>ï¼šè¡€é‡é«˜ï¼Œè€æ‰“ã€‚</li>
                                <li><strong>å§µå¦¤</strong>ï¼šç­”å°å›è¡€ï¼ŒçºŒèˆªåŠ›å¼·ã€‚</li>
                                <li><strong>å¦˜è</strong>ï¼šç­”éŒ¯æ¸›å‚·ï¼Œå®¹éŒ¯ç‡é«˜ã€‚</li>
                                <li><strong>ä½‘è¾°</strong>ï¼šç­”å°å¤§å¹…å›è¡€ï¼Œç”Ÿå­˜å°ˆå®¶ã€‚</li>
                                <li><strong>ç§‰å®¶</strong>ï¼šæ”»æ“ŠåŠ›è¶…é«˜ï¼Œä¸€æ“Šå¿…æ®ºã€‚</li>
                                <li><strong>æ›¸ä»™è€é ­</strong>ï¼šç„¡æ³•æˆ°é¬¥ï¼Œå°ˆé–€ç”¨ä¾†æŸ¥çœ‹ã€Œæ”»ç•¥ç­†è¨˜ã€ã€‚</li>
                            </ul>
                            <h3 class="text-lg font-bold text-white">ç©æ³•èªªæ˜</h3>
                            <p>é¸æ“‡é—œå¡é€²è¡Œç­”é¡Œæˆ°é¬¥ï¼Œç­”å°æ‰£æ•µè¡€ï¼Œç­”éŒ¯æ‰£å·±è¡€ã€‚æ¯å€‹ä¸–ç•Œæœ€å¾Œéƒ½æœ‰ä¸€å€‹æ“æœ‰ 500 è¡€é‡çš„ã€Œé­”ç‹é—œã€ï¼Œè€ƒé©—ä½ çš„ç¶œåˆå¯¦åŠ›ï¼</p>
                            
                            <!-- æ–°å¢éƒ¨åˆ† -->
                            <h3 class="text-lg font-bold text-white">ğŸ† æˆ°ç¸¾ç©åˆ†è¦å‰‡</h3>
                            <div class="bg-slate-800 p-3 rounded-lg border border-slate-600 text-sm">
                                <p class="mb-2 text-amber-300 font-bold">ç¸½åˆ† = (ç­”å°é¡Œæ•¸ Ã— 1000) Ã— (ç­”å°ç‡)Â² + æ™‚é–“åŠ æˆ</p>
                                <ul class="list-disc pl-4 space-y-1 text-slate-400">
                                    <li><strong>æ¥µåº¦é‡è¦–ç­”å°ç‡</strong>ï¼šå› ç‚ºæ˜¯å¹³æ–¹è¨ˆç®—ï¼ŒéŒ¯ä¸€é¡Œåˆ†æ•¸æœƒæ‰£éå¸¸å¤šï¼(ä¾‹ï¼šç­”å°ç‡ 80%ï¼Œåˆ†æ•¸åªå‰© 64%)</li>
                                    <li><strong>æ™‚é–“åŠ æˆ</strong>ï¼šåŸºæº– 300 ç§’ï¼Œæ¯ææ—© 1 ç§’ + 10 åˆ†ã€‚</li>
                                    <li><strong>åˆ†ä¸–ç•Œè¨ˆç®—</strong>ï¼šæ¯å€‹ä¸–ç•Œçš„ç©åˆ†æ˜¯åˆ†é–‹ç´¯ç©çš„ï¼Œç„¡æ³•å¸¶åˆ°ä¸‹ä¸€å€‹ä¸–ç•Œã€‚</li>
                                    <li><strong>ç­–ç•¥å»ºè­°</strong>ï¼šå¯§å¯æ…¢ä¸€é»æƒ³æ¸…æ¥šï¼Œä¹Ÿä¸è¦äº‚çŒœå–”ï¼</li>
                                </ul>
                            </div>
                        </div>
                        <div class="p-4 border-t border-slate-700">
                            <button onclick="toggleGameIntro()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">æˆ‘æº–å‚™å¥½äº†ï¼</button>
                        </div>
                    </div>
                </div>`;
            }

            if (showLeaderboard) {
                const currentWorldTitle = GAME_DATA.worlds[activeLeaderboardTab].title;
                const filteredData = leaderboardData.filter(d => d.world && d.world.includes(GAME_DATA.worlds[activeLeaderboardTab].title.split('ï¼š')[1].split(' (')[0])); 

                content += `
                <div class="absolute inset-0 z-50 bg-black/90 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-slate-900 border border-amber-500/50 w-full max-w-2xl h-3/4 rounded-xl flex flex-col shadow-2xl">
                        <div class="flex justify-between items-center p-4 border-b border-slate-700">
                            <h2 class="text-xl font-bold text-amber-400 flex items-center gap-2"><i data-lucide="trophy"></i> è‹±é›„æ¦œ</h2>
                            <button onclick="toggleLeaderboard()" class="text-slate-400 hover:text-white">âœ•</button>
                        </div>
                        <div class="flex bg-slate-800 p-2 gap-2 overflow-x-auto">
                            ${GAME_DATA.worlds.map((w, i) => `
                                <button onclick="switchLeaderboardTab(${i})" class="px-3 py-1 rounded text-sm whitespace-nowrap ${activeLeaderboardTab === i ? 'bg-amber-600 text-white' : 'bg-slate-700 text-slate-400'}">
                                    W${i+1}
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex-1 overflow-y-auto p-4">
                            <table class="w-full text-sm leaderboard-table">
                                <thead>
                                    <tr>
                                        <th class="col-rank">æ’å</th>
                                        <th class="col-player">ç©å®¶</th>
                                        <th class="col-role">è§’è‰²</th>
                                        <th class="col-level">ç­‰ç´š</th>
                                        <th class="col-score">ç©åˆ†</th>
                                    </tr>
                                </thead>
                                <tbody class="text-slate-300">
                                    ${filteredData.length > 0 ? filteredData.map((d, i) => `
                                        <tr>
                                            <td class="font-bold text-center ${i < 3 ? 'text-yellow-400' : 'text-slate-500'}">#${i + 1}</td>
                                            <td class="truncate">${d.name}</td>
                                            <td class="truncate text-slate-400">${d.role}</td>
                                            <td class="text-center text-slate-400">Lv.${d.level}</td>
                                            <td class="text-right text-amber-500 font-mono font-bold">${d.score}</td>
                                        </tr>
                                    `).join('') : `<tr><td colspan="5" class="text-center py-8 text-slate-500">æš«ç„¡è³‡æ–™ï¼Œå¿«å»æŒ‘æˆ°å§ï¼</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            }

            content += `</main>`;
            
            if (showDebugButton) {
                content += `<button onclick="diagnoseConnection()" class="fixed bottom-4 right-4 p-2 bg-slate-800/80 hover:bg-slate-700 text-slate-400 text-xs rounded-full border border-slate-600 flex items-center gap-1 z-50">
                    <i data-lucide="wrench" class="w-3 h-3"></i> æ¸¬è©¦é€£ç·š
                </button>`;
            }

            app.innerHTML = content;
            lucide.createIcons();
            const logEl = document.getElementById('battle-log-container');
            if (logEl) logEl.scrollTop = logEl.scrollHeight;
        }

        function renderStart() {
            return `<div class="flex flex-col items-center justify-center h-full p-6 bg-slate-900 text-center animate-fade-in relative">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80')] bg-cover bg-center opacity-20 pointer-events-none"></div>
                <div class="z-10 bg-slate-900/90 p-8 rounded-2xl border-4 border-amber-600 shadow-2xl max-w-md w-full backdrop-blur-sm">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-yellow-200 mb-2 drop-shadow-sm">è¥¿å¯§æ¢éšªå®¶</h1>
                    <h2 class="text-xl text-amber-200 mb-6 font-serif tracking-widest">å››ç•Œå‚³èªª</h2>
                    <div class="space-y-3">
                        <button onclick="toCharSelect()" class="w-full py-4 text-lg bg-amber-600 hover:bg-amber-500 text-white border-b-4 border-amber-800 rounded-lg font-bold shadow-md transition-all active:scale-95 animate-pulse flex items-center justify-center gap-2">
                            <i data-lucide="rocket"></i> é–‹å§‹å†’éšª
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="toggleLeaderboard()" class="py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 border-b-4 border-slate-900 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="trophy"></i> è‹±é›„æ¦œ
                            </button>
                            <button onclick="toggleGameIntro()" class="py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 border-b-4 border-slate-900 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="book-open"></i> éŠæˆ²ä»‹ç´¹
                            </button>
                        </div>
                    </div>
                    <p class="text-slate-500 text-xs mt-6">ç©¿æ¢­æ–¼è‡ªç„¶ã€ç¤¾æœƒèˆ‡æ­·å²çš„è©¦ç…‰ï¼</p>
                </div>
            </div>`;
        }

        function renderCharSelect() {
            return `<div class="flex flex-col items-center p-6 h-full overflow-y-auto bg-slate-900">
                <div class="flex justify-between items-center w-full max-w-4xl mb-6">
                    <h2 class="text-2xl font-bold text-white">é¸æ“‡è§’è‰²</h2>
                    <button onclick="returnToMainMenu()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm border border-slate-600">è¿”å›ä¸»é¸å–®</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-4xl pb-4">
                    ${CHARACTERS.map(c => `
                    <button onclick="selectCharacter('${c.id}')" class="bg-slate-800 p-4 rounded-xl border-2 ${c.id==='book_immortal'?'border-amber-500/50 col-span-1 md:col-span-2':'border-slate-700 hover:border-amber-500'} text-left transition-all">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-2 rounded-full ${c.gender==='boy'?'bg-blue-900 text-blue-300':c.id==='book_immortal'?'bg-amber-900 text-amber-300':'bg-pink-900 text-pink-300'} flex items-center justify-center text-2xl h-12 w-12">
                                ${c.avatar || (c.id === 'book_immortal' ? 'ğŸ“–' : 'ğŸ‘¤')}
                            </div>
                            <span class="text-lg font-bold text-white">${c.name}</span>
                        </div>
                        <p class="text-sm text-slate-400 mb-2">${c.desc}</p>
                        <div class="text-xs text-amber-400 font-bold"><i data-lucide="sparkles" class="inline w-3 h-3"></i> ${c.abilityName}</div>
                    </button>`).join('')}
                </div>
            </div>`;
        }

        function renderMap() {
            const world = GAME_DATA.worlds[currentWorldIndex];
            let svg = '';
            const normalZones = world.zones.filter(z => !z.id.startsWith('boss'));
            const bossZone = world.zones.find(z => z.id.startsWith('boss'));
            
            // Draw lines from all normal zones to the boss to indicate requirement
            if (bossZone) {
                 const bossUnlocked = unlockZone(bossZone.id);
                 normalZones.forEach(z => {
                     const s = z.mapPos;
                     const e = bossZone.mapPos;
                     // Line is active if the specific normal zone is completed (contributing power to unlock boss)
                     const isZoneCompleted = player.completedZones.includes(z.id);
                     
                     // Use a subtle line style
                     svg += `<line x1="${s.left}" y1="${s.top}" x2="${e.left}" y2="${e.top}" stroke="${isZoneCompleted ? '#f59e0b' : '#334155'}" stroke-width="2" stroke-dasharray="${bossUnlocked ? '0' : '5,5'}" opacity="0.6" />`;
                 });
            }

            let html = `<div class="relative w-full h-full overflow-hidden flex flex-col"><div class="absolute top-4 left-4 z-10 text-white font-bold text-xl drop-shadow-md">${world.title}</div><div class="relative flex-1 bg-grid-pattern"><svg class="absolute inset-0 w-full h-full pointer-events-none z-0">${svg}</svg>`;
            
            world.zones.forEach((z, i) => {
                const unlocked = unlockZone(z.id), completed = player.completedZones.includes(z.id);
                const isNext = unlocked && !completed && player.role !== 'Guide';
                const isBoss = z.id.startsWith('boss');
                let cls = "w-14 h-14 rounded-full flex items-center justify-center border-4 shadow-xl cursor-pointer transition-all ";
                if (isBoss) cls += "w-16 h-16 "; 
                if (completed && player.role!=='Guide') cls += "bg-amber-100 border-amber-500 text-amber-600 scale-100";
                else if (isNext) cls += isBoss ? "bg-red-600 border-white text-white animate-pulse node-boss" : "bg-amber-600 border-white text-white animate-pulse node-pulse";
                else if (!unlocked) cls += "bg-slate-700 border-slate-600 text-slate-500 grayscale";
                else cls += isBoss ? "bg-red-900 border-red-500 text-red-500" : "bg-slate-800 border-amber-500 text-amber-500";

                html += `<div onclick="showZonePopup('${z.id}')" class="absolute transform -translate-x-1/2 -translate-y-1/2 z-10 flex flex-col items-center" style="top:${z.mapPos.top};left:${z.mapPos.left}">
                    <div class="${cls}"><i data-lucide="${completed && player.role!=='Guide' ? 'check-circle' : (!unlocked ? 'lock' : z.icon)}"></i></div>
                    <div class="mt-1 px-2 py-0.5 rounded text-[10px] font-bold shadow bg-slate-900 border border-slate-700 text-slate-200 whitespace-nowrap">${z.name}</div>
                </div>`;
            });

            if (showZoneInfo) {
                const z = showZoneInfo, idx = world.zones.findIndex(x => x.id === z.id);
                const btn = player.role === 'Guide' ? 'æŸ¥çœ‹æ”»ç•¥' : (player.completedZones.includes(z.id) ? 'å†æ¬¡æŒ‘æˆ°' : 'é–‹å§‹æŒ‘æˆ°');
                const isBoss = z.id.startsWith('boss');
                html += `<div class="absolute bottom-0 w-full bg-slate-900/95 border-t border-amber-500/30 p-6 rounded-t-2xl shadow-2xl z-50 animate-slide-up">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-slate-800 rounded-lg text-amber-500 border border-slate-700"><i data-lucide="${z.icon}"></i></div>
                            <div><h3 class="text-xl font-bold ${isBoss ? 'text-red-500' : 'text-white'}">${z.name}</h3><p class="text-xs text-amber-200/70">Lv.${idx+1}</p></div>
                        </div>
                        <button onclick="closeZonePopup()" class="text-slate-400">âœ•</button>
                    </div>
                    <p class="text-sm text-slate-300 mb-4">${z.description || (isBoss ? 'åŒ…å«æœ¬ä¸–ç•Œæ‰€æœ‰é¡Œç›®çš„çµ‚æ¥µè©¦ç…‰ï¼' : 'æº–å‚™å¥½è¿æ¥æŒ‘æˆ°äº†å—ï¼Ÿ')}</p>
                    <div class="flex flex-col gap-3">
                        <button onclick="enterZone('${z.id}')" class="w-full py-3 ${isBoss ? 'bg-red-600 hover:bg-red-500' : 'bg-amber-600 hover:bg-amber-500'} text-white rounded-lg font-bold">${btn}</button>
                        <button onclick="forgetClothes()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium text-sm">æˆ‘åªæ˜¯å¿˜äº†æ”¶è¡£æœä½ ç­‰æˆ‘</button>
                    </div>
                </div>`;
            }
            return html + `</div></div>`;
        }

        function renderGuide() {
            return `<div class="p-6 h-full flex flex-col"><div class="bg-slate-800 border-2 border-amber-500/50 rounded-xl p-6 flex-1 flex flex-col shadow-2xl relative overflow-hidden">
                <div class="flex items-center gap-3 border-b border-slate-700 pb-4 mb-4">
                    <i data-lucide="book-open" class="text-amber-400 w-8 h-8"></i>
                    <h2 class="text-2xl font-bold text-white">åœ°è³ªå¤©æ›¸</h2>
                </div>
                <div class="flex-1 overflow-y-auto pr-2 text-slate-300 leading-relaxed text-sm">
                    ${GUIDE_DATA[currentZone.id] || (currentZone.id.startsWith('boss') ? '<p>é­”ç‹é—œæ²’æœ‰æ”»ç•¥ï¼Œé€™æ˜¯å°ä½ ç¶œåˆå¯¦åŠ›çš„è€ƒé©—ï¼</p>' : 'ç„¡è³‡æ–™')}
                </div>
                <button onclick="returnToMap()" class="mt-4 w-full py-3 bg-slate-700 text-white rounded-lg font-bold">è¿”å›åœ°åœ–</button>
            </div></div>`;
        }

        function renderBattle() {
            if (!currentQuestion) return '';
            const eHp = (currentEnemy.currentHp/225)*100; 
            const pHp = (player.hp/player.maxHp)*100;
            const charAvatar = CHARACTERS.find(c => c.id === player.characterId)?.avatar || 'ğŸ›¡ï¸';

            return `<div class="p-4 h-full flex flex-col gap-4 max-w-3xl mx-auto">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800 p-3 rounded-xl border border-red-900/50 relative overflow-hidden">
                        <div id="enemy-avatar" class="text-3xl mb-1 animate-bounce-custom inline-block ${activeAnimations.enemy}">ğŸ‘¾</div>
                        <div class="font-bold text-red-400">${currentEnemy.name}</div>
                        <div class="w-full bg-slate-900 h-2 rounded mt-1"><div class="bg-red-600 h-full rounded" style="width:${eHp}%"></div></div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-xl border border-blue-900/50 relative overflow-hidden">
                        <div id="player-avatar" class="text-3xl mb-1 inline-block ${activeAnimations.player}">${charAvatar}</div>
                        <div class="font-bold text-blue-400">${player.name}</div>
                        <div class="w-full bg-slate-900 h-2 rounded mt-1"><div class="bg-green-500 h-full rounded" style="width:${pHp}%"></div></div>
                    </div>
                </div>
                <!-- æµ®å‹•æ–‡å­—å±¤ -->
                <div class="absolute inset-0 pointer-events-none overflow-hidden">
                    ${floatingEffects.map(f => `<div class="anim-float-text ${f.type} text-4xl" style="left:${f.x}%; top:${f.y}%;">${f.text}</div>`).join('')}
                </div>

                <div id="battle-log-container" class="bg-black/40 p-3 rounded-lg h-32 overflow-y-auto text-sm text-slate-300 font-mono border border-slate-700/50">
                    ${battleLog.map(l=>`<div class="mb-1 border-l-2 border-slate-600 pl-2">${l}</div>`).join('')}
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-600 flex-1 flex flex-col justify-center">
                    <div class="mb-4"><h2 class="text-lg font-bold text-white">${currentQuestion.q}</h2></div>
                    <div class="grid grid-cols-1 gap-2">
                        ${currentQuestion.shuffledOptions.map((o,i)=>`<button onclick="handleAnswer(${i})" class="p-3 bg-slate-700 hover:bg-slate-600 text-left rounded text-slate-100 font-medium active:scale-95 transition-transform"><span class="text-amber-500 mr-2 font-bold">${String.fromCharCode(65+i)}.</span>${o}</button>`).join('')}
                    </div>
                </div>
            </div>`;
        }

        function renderVictory() {
            const isUploaded = player.uploadedZones.includes(currentZone.id);
            const uploadBtn = isUploaded 
                ? `<button disabled class="px-8 py-3 bg-slate-700 text-slate-500 rounded-lg font-bold shadow-lg cursor-not-allowed">å·²ä¸Šå‚³</button>`
                : `<button onclick="uploadScore()" class="px-8 py-3 bg-amber-600 text-white rounded-lg font-bold shadow-lg animate-pulse">ä¸Šå‚³æˆ°ç¸¾</button>`;

            const currentWorldScore = player.worldScores[currentWorldIndex] || 0;

            return `<div class="flex flex-col items-center justify-center h-full p-6 text-center animate-fade-in">
                <div class="text-6xl mb-4 animate-bounce-custom">ğŸ†</div>
                <h1 class="text-3xl font-bold text-green-400 mb-2">æ”»ç•¥æˆåŠŸï¼</h1>
                <p class="text-slate-400 mb-6">ä½ é€šéäº† ${currentZone.name} çš„è©¦ç…‰ã€‚</p>
                
                <div class="bg-slate-800 p-4 rounded-xl mb-8 w-full max-w-sm border border-slate-700">
                    <h3 class="text-lg font-bold text-white mb-3">æœ¬æ¬¡æˆ°å ±</h3>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">â±ï¸ è€—æ™‚</span>
                        <span class="font-mono text-white">${battleStats.duration} ç§’</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">ğŸ¯ ç­”å°ç‡</span>
                        <span class="font-mono text-white">${battleStats.accuracy}%</span>
                    </div>
                     <div class="flex justify-between items-center mb-2 border-t border-slate-700 pt-2">
                        <span class="text-amber-200">â• æœ¬é—œå¾—åˆ†</span>
                        <span class="font-mono text-white font-bold">+${battleStats.score}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-amber-500 font-bold">âœ¨ æœ¬ä¸–ç•Œç¸½åˆ†</span>
                        <span class="font-mono text-2xl text-amber-400 font-bold">${currentWorldScore}</span>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="returnToMap()" class="px-8 py-3 bg-slate-600 text-white rounded-lg font-bold shadow-lg">è¿”å›åœ°åœ–</button>
                    ${player.role !== 'Guide' ? uploadBtn : ''}
                </div>
            </div>`;
        }

        function renderGameOver() {
            return `<div class="flex flex-col items-center justify-center h-full p-6 text-center animate-fade-in">
                <div class="text-6xl mb-4">â˜ ï¸</div>
                <h1 class="text-3xl font-bold text-red-500 mb-2">æ¢ç´¢å¤±æ•—...</h1>
                <button onclick="restartGame()" class="px-8 py-3 bg-red-800 text-white rounded-lg font-bold shadow-lg">é‡æ–°é–‹å§‹</button>
            </div>`;
        }

        renderApp();
    </script>
</body>
</html>
